timeout_blk='';timeout_hnd='';proc_id='';waittime=16;statusstr=statusstr3=statusstr2='';vjia=[0, 1, 2, 3];console_type=0;prdpas=new Array(4);function WAIT4NEXT(N){if(timeout_hnd) clearTimeout(timeout_hnd);i=Math.random();if(inputKey>0){timeout_hnd=setTimeout(N+'(); ', waittime);return;}inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("'+N+'"); ', 10);}function SET_NEXT(CD, TM){var t=TM-10;if(timeout_hnd) clearTimeout(timeout_hnd);if(audio_playing==''){if(t<10) t=10;timeout_hnd=setTimeout(CD, t);return;}timeout_hnd=setTimeout('SET_NEXT("'+CD+'", '+t+'); ', 10);}function BANZHUANG_START(){if(timeout_hnd) clearTimeout(timeout_hnd);if(lang!='en') setMenuItem('MENU_RESTART', -8, 3.6, '菜単に戻る', 'QUIT_GAME()', 0);else setMenuItem('MENU_RESTART', -7, 6, 'Back to Menu.', 'QUIT_GAME()', 0);en_tapOrClick=(window.ontouchstart===null)? 'Tap' : 'Click';jiastr=['貴家', '下家', '対門', '上家'];if(lang=='en') jiastr=['You', 'Right', 'Center', 'Left'];nukidora=[0,0,0];rule.base_score=0;rule.gangdora=0;shugi=[0, 0, 0, 0];yktr=[0, 0, 0, 0];rule.dobon=0;rule.agariyame=0;if(gameMode==GAMEMODE_TAIWAN){sc=[0,0,0,0];players=4;rule.dobon=0;rule.tsumi_rong=1;rule.tsumi_mohe=1;rule.reach_bet=0;rule.score_unit=1;rule.lianjiahe=false;rule.kuinaoshi=2;gameModeSpecial=0;rule.yakitori=rule.goshugi=0;}else if(gameMode==GAMEMODE_GUOJI){sc=[0,0,0,0];players=4;rule.dobon=0;rule.tsumi_rong=0;rule.tsumi_mohe=0;rule.reach_bet=0;rule.score_unit=1;rule.lianjiahe=false;rule.kuinaoshi=0;gameModeSpecial=0;rule.yakitori=rule.goshugi=0;gm_hands=gm_hana=4;if(lang=='en'){if(rule.gm_flowerTiles_en) gm_hana=0;if(rule.gm_gamehands_en) gm_hands=2;}else {if(rule.gm_hanapai) gm_hana=0;if(!rule.gm_gamehands) gm_hands=2;}}else if(gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_EASTERN_BOO){sc=[250, 250, 250, 250];players=4;rule.base_score=300;rule.lianjiahe=true;rule.uradora=rule.uradora_init;rule.buting_lunzhuang=1;rule.pingju_lunzhuang1=0;rule.pingju_lunzhuang2=1;rule.tsumi_rong=3;rule.tsumi_mohe=1;rule.reach_bet=10;rule.score_unit=100;rule.kuinaoshi=2;qiduizi_fu=mo8pinghe;gameModeSpecial=0;rule.dobon=1;rule.agariyame=0;rule.kuitan_sakizuke=rule.kuitan_sakizuke_sel;if(lang=='en'){sc=[0, 0, 0, 0];rule.uradora_init=2;rule.zhuangfeng=1;rule.akapai_init=1;if(rule.redFive_en){rule.akapai_init=2;}mo8pinghe=1;qiduizi_fu=1;if(!rule.swapCalling_en){rule.kuinaoshi=0;}rule.kuitan_sakizuke=1;if(!rule.kuitan_en){rule.kuitan_sakizuke=-1;}else if(rule.kuitan_en>1){rule.kuitan_sakizuke=0;}rule.dobon=0;rule.yakitori=rule.goshugi=0;rule.gangdora=1;}else {rule.gangdora=0;rule.dobon=rule.dobon_sel ? 0 : 1;rule.agariyame=rule.agariyame_sel ? 0 : 1;rule.lianjiahe=rule.liangjiahe_sel ? false : true;if(rule.aotenjyo==1){gameModeSpecial |= GAMEMODE_SPECIAL_AOTENJYO;rule.dobon=0;}else if(rule.aotenjyo==2){gameModeSpecial |= GAMEMODE_SPECIAL_SEMI_AOTENJYO;rule.dobon=0;}if(rule.yakitori) yktr=[1,1,1,1];}if(gameMode==GAMEMODE_EASTERN_BOO){sc=[80, 80, 80, 80];players=4;gameModeSpecial=0;rule.kuinaoshi=2;rule.base_score=80;rule.gangdora=0;rule.uradora=0;rule.agariyame=0;qiduizi_fu=mo8pinghe=1;rule.lianjiahe=false;rule.dobon=1;yktr=[0,0,0,0];}}else if(gameMode==GAMEMODE_REACH3P){gameMode=GAMEMODE_REACH;sc=[250, 250, 250, 250];players=3;rule.base_score=300;rule.lianjiahe=true;rule.uradora=1;rule.buting_lunzhuang=1;rule.pingju_lunzhuang1=0;rule.pingju_lunzhuang2=1;rule.tsumi_rong=1;rule.tsumi_mohe=1;rule.reach_bet=10;rule.score_unit=100;rule.kuinaoshi=2;nukidora=[34,0,0];gameModeSpecial=0;rule.kuitan_sakizuke=rule.kuitan_sakizuke_sel;rule.gangdora=0;rule.dobon=rule.dobon_sel ? 0 : 1;rule.agariyame=rule.agariyame_sel ? 0 : 1;rule.lianjiahe=rule.liangjiahe_sel ? false : true;if(rule.aotenjyo==1){gameModeSpecial |= GAMEMODE_SPECIAL_AOTENJYO;rule.dobon=0;}else if(rule.aotenjyo==2){gameModeSpecial |= GAMEMODE_SPECIAL_SEMI_AOTENJYO;rule.dobon=0;}if(rule.yakitori) yktr=[1,1,1,1];}else if(gameMode==GAMEMODE_PENGLI){sc=[0, 0, 0, 0];players=3;rule.dobon=0;rule.base_score=0;rule.lianjiahe=true;rule.uradora=0;rule.buting_lunzhuang=1;rule.pingju_lunzhuang1=0;rule.pingju_lunzhuang2=1;rule.tsumi_rong=0;rule.tsumi_mohe=0;rule.reach_bet=0;rule.score_unit=1;rule.kuinaoshi=2;mo8pinghe=0;nukidora=[0,0,0];gameModeSpecial=GAMEMODE_SPECIAL_AOTENJYO;rule.yakitori=rule.goshugi=0;rule.lianjiahe=rule.liangjiahe_sel ? false : true;}else if(gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI){sc=[30, 30, 30, 30];players=3;rule.dobon=1;rule.base_score=50;rule.lianjiahe=true;rule.uradora=1;rule.buting_lunzhuang=1;rule.pingju_lunzhuang1=0;rule.pingju_lunzhuang2=1;rule.tsumi_rong=1;rule.tsumi_mohe=1;rule.reach_bet=0;rule.score_unit=1;rule.kuinaoshi=2;mo8pinghe=1;nukidora=[21,29,34];rule.lianjiahe=rule.liangjiahe_sel ? false : true;if(gameMode==GAMEMODE_BEINUKI){nukidora=[34,0,0];}rule.kuitan_sakizuke=rule.kuitan_sakizuke_sel;gameModeSpecial=0;rule.gangdora=0;rule.yakitori=rule.goshugi=0;}else if(gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_ARSHIAR){sc=[200, 200, 200, 200];players=4;rule.dobon=0;rule.base_score=200;rule.lianjiahe=false;rule.uradora=0;rule.buting_lunzhuang=-1;rule.pingju_lunzhuang1=1;rule.pingju_lunzhuang2=0;rule.tsumi_rong=10;rule.tsumi_mohe=10;rule.reach_bet=0;rule.score_unit=10;rule.kuinaoshi=0;gameModeSpecial=0;rule.yakitori=rule.goshugi=0;}if(players==3) jiastr=['貴家', '下家', '上家', ''];j=4+Math.floor(6*Math.random())+Math.floor(6*Math.random())+Math.floor(6*Math.random())+Math.floor(6*Math.random());jijia=zhuangjia=j % players;zhuangfeng=[31, 0];kyoku=kyotaku=tsumi=0;if(gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_EASTERN_BOO){if(rule.zhuangfeng==4){ zhuangfeng=[31, 32]; }if(rule.zhuangfeng==-1) kyoku=players;}_fu_disped=[0, 0, 0, 0];noMakeWin=0;timeout_hnd=setTimeout('YIJU_START(); ', waittime);}function QUIT_GAME(){if(lang=='en'){if(confirm('Are you sure to QUIT the current game to go back to Menu?')){if(spb_timeout) SPEECH_BALOON_ERASE();clearTimeout(timeout_hnd);clearTimeout(timeout_blk);AUDIO_FORCEEND();disped_player=0;callback_flick=null;EN_MAIN_START();}return;}if(confirm('現在のゲームを終了して、菜単に戻りますか？')){if(spb_timeout) SPEECH_BALOON_ERASE();clearTimeout(timeout_hnd);clearTimeout(timeout_blk);AUDIO_FORCEEND();disped_player=0;callback_flick=null;MAIN_START();}}function IF_QUITTED(){if(!quitted) return;quitted=0;clearTimeout(timeout_hnd);clearTimeout(timeout_blk);if(lang=='en'){EN_MAIN_START(); return;}MAIN_START();}function YIJU_START(){if(timeout_hnd) clearTimeout(timeout_hnd);var scc, a, b, c;var i, j, k, p,  x, y, z;var st=new Array(4);gm_lipai_default=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];dora=[0,0,0,0,0];doraD=[0,0,0,0,0];uradora=[0,0,0,0,0];uradoraD=[0,0,0,0,0];j_tmpi=[0,0,0,0];j_txpi=[0,0,0,0];j_tmpf=[0,0,0,0];takingCare=0;i=players; j=-0xffff; k=0;while(--i>-1){l=sc[i];if(l==j){k=8; continue;}if(l>j){k=i; j=l;}}if((k<1 && cpuLevel>0) || (rule.base_score>0 && sc[0]>rule.base_score)){noMakeWin=1;}statusstr=statusstr2=statusstr3=''; shibari=1;if(gameMode==GAMEMODE_REACH && rule.liangfan_shibari){if(tsumi>4){ shibari=2;statusstr2='両翻縛りです。';if(lang=='en') statusstr2='2 fan or more required to win.';}}gm_lipaiMode=-1;i=0; p=0;if(gameMode==GAMEMODE_TAIWAN){while(++i<38){if(i==10 || i==20 || i==30) continue;bp[p++]=i; bp[p++]=i; bp[p++]=i; bp[p++]=i;}if(!rule.tw_hanapai){i=39; while(++i<48) bp[p++]=i;}}else if(gameMode==GAMEMODE_ARSHIAR){while(++i<38){if(i==10 || i==20 || i==30) continue;bp[p++]=i; bp[p++]=i; bp[p++]=i; bp[p++]=i;}}else if(gameMode==GAMEMODE_GUOJI){while(++i<38){if(i==10 || i==20 || i==30) continue;bp[p++]=i; bp[p++]=i; bp[p++]=i; bp[p++]=i;}if(gm_hana){bp[p++]=40; bp[p++]=40; bp[p++]=40; bp[p++]=40;bp[p++]=40; bp[p++]=40; bp[p++]=40; bp[p++]=40;}}else if(gameMode==GAMEMODE_PENGLI){while(++i<30){if(i==10 || i==20 || i==30) continue;bp[p++]=i; bp[p++]=i;  bp[p++]=i;  bp[p++]=i;}}else if(players==3){while(++i<38){if(i==10 || i==20 || i==30 || (i>21 && i<29)) continue;bp[p++]=i; bp[p++]=i; bp[p++]=i; bp[p++]=i;}}else {while(++i<38){if(i==10 || i==20 || i==30) continue;bp[p++]=i; bp[p++]=i;  bp[p++]=i;  bp[p++]=i;}if(gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_EASTERN_BOO){if(gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_EASTERN_BOO || !rule.akapai_init) bp[52]=bp[53]=65;else if(rule.akapai_init==1){ bp[16]=55; bp[52]=65; bp[88]=75; }}}i=p; while(--i>=0){k=Math.floor(p*Math.random());j=bp[i]; bp[i]=bp[k]; bp[k]=j;}i=p; while(--i>=0){k=Math.floor(p*Math.random());j=bp[i]; bp[i]=bp[k]; bp[k]=j;}i=p; while(--i>=0){k=Math.floor(p*Math.random());j=bp[i]; bp[i]=bp[k]; bp[k]=j;}i=p; while(--i>=0){k=Math.floor(p*Math.random());j=bp[i]; bp[i]=bp[k]; bp[k]=j;}bipai_end=p;bipaiPtr=0; i=players;while(--i>=0){mq[i]=0;nr[i]=-1;opened[i]=0;ippatsu[i]=0;reach[i]=0;mp_ctr[i]=0;ft[i]=0;fc[i]=0;j=24; while(--j>=0) dp[i][j]=0;dc[i]=0;j=16; while(--j>=0) mp[i][j]=0;rdcf[i]=0;frkr[i]=0;ndr_ctr[i]=0;j=16; while(--j>=0) ndr[i][j]=0;j=20; while(--j>-1) te[i][j]=0;j=14; while(--j>0) te[i][j]=bp[bipaiPtr++];if(gameMode==GAMEMODE_TAIWAN){te[i][17]=bp[bipaiPtr++];te[i][18]=bp[bipaiPtr++];te[i][19]=bp[bipaiPtr++];}fs2c[i]=0;j=40; while(--j>-1) wants[i][j]=fsp[i][j]=trp[i][j]=tm_guoshui[i][j]=0;texp[i].flag=texp[i].mxf=texp[i].mxfc=texp[i].avf=0;tm_baxianguohai[i]=0;j=shugi_name.length; while(--j>-1) shugiB[i][j]=0;}nrykfan=[0,0,0,0];rm_2naki=[0,0,0,0];var mstn=[0, 0, 0, 0];var mxtn=[0, 0, 0, 0];x=-1; y=-1; z=-1;i=players; while(--i>-1){mxtn[i]=a0138(0);st=[0, 0, 0, 0];SHUPAI_MOVE(i);k=38; while(--k>0){if((k % 10)==0) continue;st[Math.floor(k / 10)]+=pai_tbl[k];}if(players==3 && gameMode!=GAMEMODE_PENGLI) st[2]=0;mstn[i]=Math.max(st[0], Math.max(st[1], Math.max(st[3], st[2])));}if(!noMakeWin){}else {x=-1; y=-1; i=players; while(--i>0){if(mxtn[i]==y){if(x>0 && mstn[x]>mstn[i]) x=i;continue;}if(mxtn[i]<y) continue;x=i; y=mxtn[i];}if(gameMode!=GAMEMODE_TAIWAN && x>0 && (z=mstn[x]-1)>6){i=players; while(--i>0){if(mxtn[i]+1<y) continue;if(mstn[i]<z){z=mstn[i]; x=i;}}}if(x>0){i=20; while(--i>-1){j=te[x][i]; te[x][i]=te[0][i]; te[0][i]=j;}j=mxtn[x]; mxtn[x]=mxtn[0]; mxtn[0]=j;}j=-0x7fff; k=-1; i=players; while(--i>0){if(sc[i]==j){if(i==zhuangjia) k=i;continue;}if(sc[i]>j){k=i; j=sc[i];}}if(k>0){x=k; y=mxtn[k];i=players; while(--i>0){if(i==k) continue;if(mxtn[i]==y){if(x==zhuangjia) x=i;else if(i==zhuangjia) continue;}if(mxtn[i]<y){x=i; y=mxtn[i];}}if(x>0){i=20; while(--i>-1){j=te[x][i]; te[x][i]=te[k][i]; te[k][i]=j;}}}}noMakeWin=1;i=5; while(--i>-1) doraD[i]=dora[i]=uradoraD[i]=uradora[i]=0;if(gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_EASTERN_BOO){k=bp[bipaiPtr++];doraD[0]=k;k=1+k % 50;if(players==3 && k==22) k=29
else if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;dora[0]=k;k=bp[bipaiPtr++];uradoraD[0]=k;k=1+k % 50;if(players==3 && k==22) k=29
else if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;uradora[0]=k;}else if(gameMode==GAMEMODE_BOO){k=bp[bipaiPtr++];doraD[0]=k;k=1+k % 50;if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;dora[0]=k;}if(gameMode==GAMEMODE_TAIWAN){l=Math.floor(Math.random()*4)+31;}else if(players==3){l=34-zhuangjia; if(l==34) l=31;}else {l=35-zhuangjia; if(l==35) l=31;}i=-1;while(++i<players){menfeng[i]=l; l++;if(players==3){if(l>33) l=31;}else {if(l>34) l=31;}j=40; while(--j>=0){fsp[i][j]=0;zp[i][j]=0;}j=38; while(--j>0){if(j==30 || j==20 || j==10) --j;zp[i][j]=4;}j=14; while(--j>0){k=te[i][j] % 50;if(k<38) zp[i][k]--;}zp[i][doraD[0]]--;j=20; while(--j>=0) fl[i][j]=0;}xt[1]=xt[2]=xt[3]=256;dja[0][0]=dja[0][1]=dja[0][2]=dja[0][3]=dja[0][4]=dja[1][0]=dja[1][1]=dja[1][2]=dja[1][3]=dja[1][4]=dja[2][0]=dja[2][1]=dja[2][2]=dja[2][3]=dja[2][4]=dja[3][0]=dja[3][1]=dja[3][2]=dja[3][3]=dja[3][4]=-1;i=20; while(--i>=0) dpOK[i]=0;jia=players; while(--jia>-1) LIPAI(jia);doraCtr=0;gangCtr=0;reachCtr=0;yaojiu_furikiri=0;shisanbuta=0;yixun=0;tianhe=0;ronghe=0;lingshang=0;zampai=69;if(gameMode==GAMEMODE_GUOJI){zampai=83;if(gm_hana) zampai=91;}else if(gameMode==GAMEMODE_TAIWAN){zampai=63;if(rule.tw_hanapai) zampai-=8;}else if(gameMode==GAMEMODE_REACH && players==3) zampai=54;else if(gameMode==GAMEMODE_SAMMA) zampai=50;else if(gameMode==GAMEMODE_BEINUKI) zampai=54;else if(gameMode==GAMEMODE_PENGLI) zampai=68;uradora_opened=0;pengchi=0;angang=0;qianggang=0;gangjia=-1;diyidapai=-1;cdp[0]=cdp[1]=0;sigangziBabao=-1;gang_pos=-1;tm_dapai_ptr=0;i=11; while(--i>-1){tm_dapai[i]=new Array(11);tm_dapaiDir[i]=new Array(11);tm_dapaiDxy[i]=new Array(11);j=11; while(--j>-1){tm_dapai[i][j]=0;tm_dapaiDir[i][j]=Math.floor(Math.random()*4);tm_dapaiDxy[i][j]=Math.floor(Math.random()*6);}}tm_dapai[ 0][ 8]=tm_dapai[ 0][ 9]=tm_dapai[ 0][10]=tm_dapai[ 1][ 9]=tm_dapai[ 1][10]=tm_dapai[ 1][ 0]=tm_dapai[ 1][ 1]=tm_dapai[ 1][ 2]=tm_dapai[ 8][ 0]=tm_dapai[ 8][ 8]=tm_dapai[ 8][ 9]=tm_dapai[ 9][ 0]=tm_dapai[ 9][ 1]=tm_dapai[ 9][ 2]=tm_dapai[ 9][ 9]=tm_dapai[ 9][10]=tm_dapai[10][ 9]=tm_dapai[10][10]=-1;if(grMode){tm_dapai[2][ 0]=tm_dapai[2][ 1]=-1;tm_dapai[8][ 1]=tm_dapai[8][ 2]=-1;tm_dapai[8][ 8]=0;tm_dapai[9][ 3]=tm_dapai[9][ 4]=0;tm_dapai[9][ 3]=tm_dapai[9][ 4]=tm_dapai[9][ 5]=tm_dapai[9][ 6]=-1;tm_dapai[9][ 9]=tm_dapai[9][10]=0;}tm_dapaiBuff=0;tm_minggang=0;gm_zuhelong_hand=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];i=40; while(--i>=0) gm_dp[i]=0;nukidora_jia=-1;bn_lingshangdora=[0,0];bn_lingshangdoraD=[0,0];prdpas=[0,0,0,0];a0090();gm_lipaiMode=-1;jiaBuff=zhuangjia;dajia=-1;paiBuff=te[zhuangjia][14]=bp[bipaiPtr++];k=paiBuff % 50;if(k<38) zp[zhuangjia][k]--;fdat_disp=0;console_mode=0;PLAY_SCREEN();e=document.getElementById('SCORE'+zhuangjia);e.style.border='1px solid #ff0';l=players; while(--l>=0){SHUPAI_DISP(l);}DORA_DISP();ZAMPAI_DISP();callback_flick=HAND_CHANGER_BY_FLICK;_fu_disped=[0, 0, 0, 0];timeout_hnd=setTimeout('WQGFDSHTRD(); ', waittime);if(statusstr2!='') STATUS_DISP(statusstr2);}function WQGFDSHTRD(){if(timeout_hnd) clearTimeout(timeout_hnd);var i, j;paiBuff=-1; cmd=-1;cmd=16; while(++cmd<20){if((j=te[jiaBuff][cmd] % 50)>39){ paiBuff=j; break; }}if(paiBuff<0){cmd=0; while(++cmd<15){if((j=te[jiaBuff][cmd] % 50)>39){ paiBuff=j; break; }}}if(paiBuff<0){if(jiaBuff!=zhuangjia){TINGPAI_JUDGE2(jiaBuff, 0);a0091(jiaBuff);}if(++jiaBuff>=players) jiaBuff=0;if(jiaBuff==zhuangjia){paiBuff=te[zhuangjia][14];te[zhuangjia][14]=0;TINGPAI_JUDGE2(jiaBuff, 0);te[zhuangjia][14]=paiBuff;timeout_hnd=setTimeout('AFTER_DSWEWSEW(); ', waittime);return;}timeout_hnd=setTimeout('WQGFDSHTRD(); ', 10);return;}te[jiaBuff][cmd]=0;SHUPAI_DISP(jiaBuff);timeout_hnd=setTimeout('WQGFDSHTRD_2(); ', waittime);}function WQGFDSHTRD_2(){if(timeout_hnd) clearTimeout(timeout_hnd);var i, j;ndr[jiaBuff][ndr_ctr[jiaBuff]++]=paiBuff;te[jiaBuff][cmd]=te[jiaBuff][14];te[jiaBuff][14]=0;if(gameMode==GAMEMODE_TAIWAN && ndr_ctr[jiaBuff]>7) tm_baxianguohai[jiaBuff]=1;SHUPAI_DISP(jiaBuff);timeout_hnd=setTimeout('WQGFDSHTRD_3(); ', waittime);}function WQGFDSHTRD_3(){if(timeout_hnd) clearTimeout(timeout_hnd);var i, j;paiBuff=bp[bipaiPtr++];te[jiaBuff][14]=paiBuff;if(paiBuff % 50<38) zp[jiaBuff][paiBuff % 50]--;--zampai; ZAMPAI_DISP();SHUPAI_DISP(jiaBuff);ZAMPAI_DISP();if(jiaBuff!=zhuangjia){if(gameMode==GAMEMODE_TAIWAN){i=20; while(--i>=0) pai_tbl[i]=0;i=17; j=15; while(--j>0){if((k=te[jiaBuff][j])!=0) pai_tbl[--i]=k;}if((k=te[jiaBuff][19])!=0) pai_tbl[--i]=k;if((k=te[jiaBuff][18])!=0) pai_tbl[--i]=k;if((k=te[jiaBuff][17])!=0) pai_tbl[--i]=k;if(!jiaBuff || opened[jiaBuff]){j=0; while(++j<16){k1=pai_tbl[j];k2=pai_tbl[j+1];l1=k1 % 50;l2=k2 % 50;if(l1>l2 || (l1==l2 && k1>k2)){pai_tbl[j]=k2;pai_tbl[j+1]=k1;j=0;}}}te[jiaBuff][0]=0;te[jiaBuff][17]=pai_tbl[1];te[jiaBuff][18]=pai_tbl[2];te[jiaBuff][19]=pai_tbl[3];i=0; while(++i<14) te[jiaBuff][i]=pai_tbl[i+3];te[jiaBuff][14]=0;}else {i=0; while(++i<15){if(te[jiaBuff][i] % 50<1 && te[jiaBuff][14] % 50>0){te[jiaBuff][i]=te[jiaBuff][14];te[jiaBuff][14]=0;break;}}LIPAI(jiaBuff);}}else {if(gameMode==GAMEMODE_TAIWAN){i=20; while(--i>=0) pai_tbl[i]=0;i=17; j=14; while(--j>0){if((k=te[jiaBuff][j])!=0) pai_tbl[--i]=k;}if((k=te[jiaBuff][19])!=0) pai_tbl[--i]=k;if((k=te[jiaBuff][18])!=0) pai_tbl[--i]=k;if((k=te[jiaBuff][17])!=0) pai_tbl[--i]=k;if(!jiaBuff || opened[jiaBuff]){j=0; while(++j<16){k1=pai_tbl[j];k2=pai_tbl[j+1];l1=k1 % 50;l2=k2 % 50;if(l1>l2 || (l1==l2 && k1>k2)){pai_tbl[j]=k2;pai_tbl[j+1]=k1;j=0;}}}te[jiaBuff][0]=0;te[jiaBuff][17]=pai_tbl[1];te[jiaBuff][18]=pai_tbl[2];te[jiaBuff][19]=pai_tbl[3];i=0; while(++i<14) te[jiaBuff][i]=pai_tbl[i+3];}else {if(!jiaBuff || opened[jiaBuff]){j=0; while(++j<13){k1=te[jiaBuff][j];k2=te[jiaBuff][j+1];l1=k1 % 50;l2=k2 % 50;if(l1>l2 || (l1==l2 && k1>k2)){te[jiaBuff][j]=k2;te[jiaBuff][j+1]=k1;j=0;}}}}}AUDIO_OUTPUT('mopai', false);SHUPAI_DISP(jiaBuff);ZAMPAI_DISP();timeout_hnd=setTimeout('WQGFDSHTRD(); ', 320);}function AFTER_DSWEWSEW(){if(timeout_hnd) clearTimeout(timeout_hnd);bn_heleOK=0;bl[0]=bl[1]=bl[2]=bl[3]=bl_t[0]=bl_r[0]=bl_t[1]=bl_r[1]=bl_t[2]=bl_r[2]=bl_t[3]=bl_r[3]=0;gang[0]=gang[1]=gang[2]=gang[3]=0;pengOK=chiOK=gangOK=heleOK=daopaiOK=reachOK=0;ikey=-1; cmd=14;reachDeclare=0;keishikiHele=0;statusstr=statusstr2+((lang!='en') ? '打牌してください。' : en_tapOrClick+' a tile to discard.');console_type=0;if(te[jiaBuff][14] % 50>39){SHUPAI_DISP(jiaBuff);timeout_hnd=setTimeout('BUHUA_1(); ', waittime);return;}if(pengchi==0){helepai=te[jiaBuff][14];heleOK=YAKU_JUDGE(jiaBuff);if(heleOK && (gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_REACH) && lang!='en' && rule.kuitan_sakizuke>1 && mq[jiaBuff]){i=j_tmpi[jiaBuff];if(!yixun && dc[jiaBuff]<1) i+=256;if(zampai<1) ++i;if(lingshang) ++i;if(i<shibari){heleOK=0;if(jiaBuff==0) statusstr3='門前でない片和了では和了出来ません。';}}if(heleOK && (gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_EASTERN_BOO) && (str=BOO_SCORING())!=''){heleOK=0;if(!jiaBuff) statusstr=str+'は出来ません。';}if(heleOK && gameMode==GAMEMODE_TAIWAN){if(tm_guoshui[jiaBuff][paiBuff % 50]>0){heleOK=0;if(!jiaBuff) statusstr='過水のため栄和出来ません。';}if(tm_minggang){heleOK=0;if(!jiaBuff) statusstr='明槓後の槓上開花は出来ません。';}}else if(!heleOK && keishikiHele){if(!jiaBuff){if(gameMode==GAMEMODE_PENGLI && !reach[jiaBuff]){statusstr3='ポンリーは立直縛りです。';}else {statusstr3='役不足のため和了出来ません。';if(lang=='en') statusstr3='Can\'t win due to lack of <i>yaku</i>.';}}}SHUPAI_MOVE(jiaBuff);if((zampai>1 || (gameMode!=GAMEMODE_SAMMA && zampai>0)) &&    (gameMode==GAMEMODE_GUOJI || gameMode==GAMEMODE_PENGLI || gangCtr<4)){if(reach[jiaBuff]){if(gameMode!=GAMEMODE_TAIWAN){j=paiBuff % 50;i=nukidora.length; while(--i>=0){ if(nukidora[i]==j) break; }if(i<0){i=4; while(--i>=0){ if(gp[jiaBuff][i]==j) break; }if(i>=0){ gangOK=1; gang[0]=paiBuff; }}if(gameMode==GAMEMODE_PENGLI){var k=-5; i=fc[jiaBuff]; while(--i>-1){k+=5;if(fl[jia][k] % 50==j || fl[jia][k+1] % 50==j) break;}if(i>-1){ gangOK=1; gang[0]=paiBuff; }}}}else {i=38; while(--i>0){j=nukidora.length; while(--j>=0){ if(nukidora[j]==i) break; }if(j>-1) continue;j=pai_tbl[i];if(j==4){ gang[gangOK++]=i; continue; }if(j!=1) continue;l=fc[jiaBuff]; k=-5;while(--l>=0){k+=5;m=fl[jiaBuff][k] % 50;n=fl[jiaBuff][k+1] % 50;if(m==n && m==i){gang[gangOK++]=i; break;}}}}}if(gameMode!=GAMEMODE_GUOJI && gameMode!=GAMEMODE_TAIWAN){if(gameMode!=GAMEMODE_ARSHIAR){if(!mq[jiaBuff] && !reach[jiaBuff] && zampai>players-1 && (gameMode!=GAMEMODE_REACH || (sc[jiaBuff]>=10 || lang=='en' || !rule.dobon))) reachOK=1;}i=30; j=0;while(++i<38){ if(pai_tbl[i]) ++j; }i=20; do {if(pai_tbl[i+1]) ++j;if(pai_tbl[i+9]) ++j;i-=10;} while(i>=0);if(j>8 && yixun==0) daopaiOK=1;}else if(gameMode==GAMEMODE_TAIWAN && !heleOK){if(!yixun) reachOK=1;}}if(gameMode==GAMEMODE_PENGLI){if(!reach[jiaBuff] && zampai>players-1) reachOK=1;}i=20; while(--i>=0) dpOK[i]=0;if(!reach[jiaBuff]){i=20; while(--i>=0){k=te[jiaBuff][i] % 50;if(k<1 || k>37 || cdp[0]==k || cdp[1]==k) continue;if(nukidora[0]!=k && nukidora[1]!=k && nukidora[2]!=k){dpOK[i]=i; continue;}if(pengchi) continue;dpOK[i]=i;}}else dpOK[14]=1;if(reach[jiaBuff] && !gangOK && !heleOK){cmd=14;paiBuff=te[jiaBuff][14];te[jiaBuff][14]=0;timeout_hnd=setTimeout('FHRTHFSD(); ', waittime);return;}if(jiaBuff){CONSOLE_ERASE();timeout_hnd=setTimeout('DAPAI_BY_CPU(); ', waittime);return;}if(gameMode!=GAMEMODE_TAIWAN){i=-1; while(++i<16){if(!dpOK[i]) console_hand[i]='';}}console_cmd=0;inputKey=-1;SHUPAI_DISP(jiaBuff);CONSOLE_DISP();STATUS_DISP(statusstr);statusstr2='';timeout_hnd=setTimeout('DAPAI_BY_PLAYER(); ', waittime);}function BUHUA_1(){if(timeout_hnd) clearTimeout(timeout_hnd);var i, j;paiBuff=te[jiaBuff][14];cmd=14;te[jiaBuff][14]=0;if(zampai<1 && gameMode!=GAMEMODE_TAIWAN){timeout_hnd=setTimeout('FHRTHFSD(); ', waittime);return;}ndr[jiaBuff][ndr_ctr[jiaBuff]++]=paiBuff;SHUPAI_DISP(jiaBuff);timeout_hnd=setTimeout('BUHUA_2(); ', waittime);}function BUHUA_2(){if(timeout_hnd) clearTimeout(timeout_hnd);var i, j;if(zampai<1 && gameMode!=GAMEMODE_TAIWAN){timeout_hnd=setTimeout('HUANGPAI(); ', waittime);return;}paiBuff=bp[bipaiPtr++];te[jiaBuff][14]=paiBuff;if(paiBuff % 50<38) zp[jiaBuff][paiBuff % 50]--;--zampai; ZAMPAI_DISP();SHUPAI_DISP(jiaBuff);ZAMPAI_DISP();if(gameMode==GAMEMODE_TAIWAN){lingshang=1; dajia=-1;if(ndr_ctr[jiaBuff]>7) tm_baxianguohai[jiaBuff]=1;tm_minggang=0;}timeout_hnd=setTimeout('AFTER_DSWEWSEW(); ', waittime);}function DAPAI_BY_PLAYER(){if(timeout_hnd) clearTimeout(timeout_hnd);var str;i=Math.random();if(inputKey==25 && heleOK){STATUS_ERASE();CONSOLE_ERASE();timeout_hnd=setTimeout('MOHE(); ', waittime);inputKey=-1;return;}if(inputKey==24 && reachOK){if(console_cmd==24){console_cmd=0;str=(lang!='en') ? '打牌してください' : en_tapOrClick+' a tile to discard.';STATUS_DISP(str);}else if(!console_cmd){console_cmd=24;if(lang!='en'){i='立直'; if(gameMode==GAMEMODE_TAIWAN) i='聴牌宣言';str=i+'の打牌は？';}else {str=en_tapOrClick+' a tile to declare <i>riichi</i>.';}STATUS_DISP(str);}CONSOLE_DISP();inputKey=-1;timeout_hnd=setTimeout('DAPAI_BY_PLAYER(); ', waittime);return;}if(inputKey==21 && gangOK){if(console_cmd!=21){if(gangOK==1){paiBuff=gang[0];STATUS_ERASE();CONSOLE_ERASE();timeout_hnd=setTimeout('MOGANG(); ', waittime);return;}else {i=15; while(--i>0){dpOK[i]=0;j=te[0][i] % 50;k=gangOK; while(--k>=0){if(gang[k]==j) dpOK[i]=1;}}SHUPAI_DISP(0);console_cmd=21;str=(lang!='en') ? 'カン牌は？' : en_tapOrClick+' a tile for a kong.';STATUS_DISP(str);}}else {i=20; while(--i>=0) dpOK[i]=0;if(!reach[jiaBuff]){i=20; while(--i>=0){k=te[jiaBuff][i] % 50;if(k && k<38 && cdp[0]!=k && cdp[1]!=k) dpOK[i]=i;}}else dpOK[14]=1;console_cmd=0;str=(lang!='en') ? '打牌してください' : en_tapOrClick+' a tile to discard.';STATUS_DISP(str);CONSOLE_DISP();}CONSOLE_DISP();inputKey=-1;}if(inputKey==26 && daopaiOK){STATUS_ERASE();CONSOLE_ERASE();inputKey=-1;timeout_hnd=setTimeout('DAOPAI(); ', waittime);return;}if(inputKey>0 && inputKey<20 && dpOK[inputKey]){if(console_cmd==21){j=te[0][inputKey] % 50;i=gangOK; while(--i>=0){if(gang[i]==j) break;}if(i>=0){paiBuff=j;STATUS_ERASE();CONSOLE_ERASE();timeout_hnd=setTimeout('MOGANG(); ', waittime);return;}}reachDeclare=0; if(console_cmd==24) reachDeclare=1;cmd=inputKey;paiBuff=te[0][cmd];te[0][cmd]=0;STATUS_ERASE();CONSOLE_ERASE();inputKey=-1;timeout_hnd=setTimeout('FHRTHFSD(); ', waittime);return;}inputKey=-1;timeout_hnd=setTimeout('DAPAI_BY_PLAYER(); ', waittime);}function DAPAI_BY_CPU(){if(timeout_hnd) clearTimeout(timeout_hnd);if(heleOK>0){if(gameMode==GAMEMODE_BOO && sc[jiaBuff]<200){var sss=[sc[0], sc[1], sc[2], sc[3]];i=players; while(--i>=0){if(i==jiaBuff) continue;k=pay0; if(i==zhuangjia) k=pay1;sss[i]-=k+(tsumi+boo_ydora+boo_menqian)*10;sss[jiaBuff]+=k+(tsumi+boo_ydora+boo_menqian)*10;}var i, j=k=0;i=players; while(--i>=0){if(sc[i]<200) j++;if(sss[i]<200) k++;}if(!(sss[jiaBuff]<200 && k>j)){cmd=25;timeout_hnd=setTimeout('MOHE(); ', waittime);return;}}else {cmd=25;timeout_hnd=setTimeout('MOHE(); ', waittime);return;}}if(gangOK && reach[jiaBuff]){cmd=21;timeout_hnd=setTimeout('MOGANG(); ', waittime);return;}i=a0099(jiaBuff);paiBuff=te[jiaBuff][cmd];if(i==21){timeout_hnd=setTimeout('MOGANG(); ', waittime);return;}te[jiaBuff][cmd]=0;timeout_hnd=setTimeout('FHRTHFSD(); ', waittime);}function FHRTHFSD(){if(timeout_hnd) clearTimeout(timeout_hnd);var wt=waittime*2;tm_baxianguohai[jiaBuff]=0;SHUPAI_DISP(jiaBuff);i=20; while(--i>=0) dpOK[i]=0;te[jiaBuff][cmd]=te[jiaBuff][14];te[jiaBuff][14]=0;LIPAI(jiaBuff);tm_dapaiBuff=paiBuff;k=paiBuff % 50;if((nukidora[0]==k || nukidora[1]==k || nukidora[2]==k) &&    (zampai>0 || gameMode==GAMEMODE_SAMMA)){nukidora_jia=jiaBuff;i=players; while(--i>=0){if(i==jiaBuff) continue;zp[i][k]--;}reachDeclare=0;ndr[jiaBuff][ndr_ctr[jiaBuff]++]=k;TINGPAI_JUDGE2(jiaBuff, 0);SHUPAI_DISP(jiaBuff);AUDIO_OUTPUT('mopai', true);tm_minggang=0;angang=0; qianggang=1;ronghe=1;pengchi=0;dajia=jiaBuff;timeout_hnd=setTimeout('AFTER_FHRTHFSD(); ', 240);return;}nukidora_jia=-1;prdpas[jiaBuff]=k;fsp[jiaBuff][k]=trp[jiaBuff][k]=1;i=k; if(cmd==14 && !pengchi) i+=100;fs2[jiaBuff][fs2c[jiaBuff]++]=i;if(diyidapai<0) diyidapai=k;else if(diyidapai!=k) diyidapai=0;i=k % 10;if(k<30 && i>1 && i<9) frkr[jiaBuff]=1;if(k<38){i=players; while(--i>=0){if(i==jiaBuff) continue;zp[i][k]--;}}if(reach[jiaBuff]){ippatsu[jiaBuff]=0;if(keishikiHele) rm[jiaBuff]=1;reachDeclare=0;}else {i=40; while(--i>-1) trp[jiaBuff][i]=fsp[jiaBuff][i];if(mq[jiaBuff] && gameMode!=GAMEMODE_PENGLI) reachDeclare=0;if(zampai<players) reachDeclare=0;if(gameMode==GAMEMODE_GUOJI || gameMode==GAMEMODE_ARSHIAR) reachDeclare=0;if(gameMode==GAMEMODE_REACH && sc[jiaBuff]<10 && lang!='en' && rule.dobon){if(jiaBuff==0 && reachDeclare) statusstr3='立直料が払えないので立直出来ません。';reachDeclare=0;}if(gameMode==GAMEMODE_TAIWAN && yixun) reachDeclare=0;ft[jiaBuff]=rm[jiaBuff]=0;if(keishikiHele) ft[jiaBuff]=1;TINGPAI_JUDGE2(jiaBuff, 1);if(mp_ctr[jiaBuff]<1){if(jiaBuff==0 && reachDeclare) statusstr3='ノーテン立直は出来ません。';reachDeclare=0;}else if(j_tmpi[jiaBuff]<shibari && rule.kuitan_sakizuke>1){if(jiaBuff==0 && reachDeclare) statusstr3='完全先付では片和了での立直は不可。';reachDeclare=0;}if(jiaBuff && ft[jiaBuff]) reachDeclare=0;}if(reachDeclare){i='reach'+cID[jiaBuff];var tx='リーチ！';if(lang=='en') tx='Riichi!';SPEECH_BALOON(tx, i, jiaBuff);rdcf[jiaBuff]=1;wt=250;}if(gameMode==GAMEMODE_TAIWAN){i=40; while(--i>=0) tm_guoshui[jiaBuff][i]=0;}TINGPAI_JUDGE2(jiaBuff, 0);i=j_txpi[0];if((gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_SAMMA) && rule.kuitan_sakizuke>1) i=j_tmpi[0];if(!jiaBuff && i>=shibari && !ft[0] && j_tmpf[0]>4){takingCare=1;}if(yf_req<j_tmpi[jia]) j_tmpi[jia]=yf_req;if(yf_req>j_txpi[jia]) j_txpi[jia]=yf_req;timeout_hnd=setTimeout('DAPAI_2(); ', wt);}function DAPAI_2(){if(timeout_hnd) clearTimeout(timeout_hnd);jia=jiaBuff;var j=paiBuff;gm_dp[j % 50]++;if(rdcf[jiaBuff]) j+=100;if(cmd==14 && !pengchi && mogiri_disp && tianhe) j+=1000;dp[jiaBuff][dc[jiaBuff]++]=j;tm_minggang=0;angang=qianggang=0;ronghe=1;pengchi=0;dajia=jiaBuff;if(audio_playing=='dapai' || audio_playing=='mopai' || audio_playing=='') AUDIO_OUTPUT('dapai', true);timeout_hnd=setTimeout('DAPAI_2_2(); ', 60);}function DAPAI_2_2(){SHUPAI_DISP(jiaBuff);DAPAI_DISP(jiaBuff);DORA_DISP();var wt=120;timeout_hnd=SET_NEXT('AFTER_FHRTHFSD(); ', wt);}function MOHE(){if(timeout_hnd) clearTimeout(timeout_hnd);cmmd[0]=cmmd[1]=cmmd[2]=cmmd[3]=0;cmmd[jiaBuff]=25;MENFENG_COLOR(jiaBuff, 2);if(dajia>-1) MENFENG_COLOR(dajia, -1);var tx='ツモ！';if(gameMode!=GAMEMODE_GUOJI){i='mohe'+cID[jiaBuff];if(lang=='en') tx='Mahjong!';}else {i='he'+cID[jiaBuff];tx='フー！';if(lang=='en') tx='Hu!';}SPEECH_BALOON(tx, i, jiaBuff);jia=jiaBuff;opened[jiaBuff]=2;LIPAI(jiaBuff);if(gm_zuhelong_hand[13]>0){i=20; while(--i>=0) te[jiaBuff][i]=gm_zuhelong_hand[i];}te[jiaBuff][14]=paiBuff;SHUPAI_DISP(jiaBuff);var str=(lang!='en') ? jiastr[jiaBuff]+'の摸和です。' : jiastr[jiaBuff]+' won on self-draw.';STATUS_DISP(str);timeout_hnd=setTimeout('HELE(); ', waittime);}function MOGANG(){if(timeout_hnd) clearTimeout(timeout_hnd);nukidora_jia=-1;tm_baxianguohai[jiaBuff]=0;SHUPAI_MOVE(jiaBuff);j=paiBuff % 50;if(pai_tbl[j]>3){i=20; k=0; n=fc[jiaBuff]*5;gang_pos=n+4;while(--i>0){l=te[jiaBuff][i] % 50;if(l!=j) continue;paiBuff=fl[jiaBuff][n]=te[jiaBuff][i];te[jiaBuff][i]=0;++n; ++k;if(k==3){fl[jiaBuff][n]=0;n++;}if(k>3) break;}m=4; while(--m>=0){if(m==jiaBuff) continue;zp[m][j]=0;}dja[jiaBuff][fc[jiaBuff]++]=-1;angang=1;}else {n=-5; i=-1; k=fc[jiaBuff];while(++i<k){n+=5;if(fl[jiaBuff][n] % 50==j) break;}gang_pos=n+3;i=20;while(--i>0){if((l=te[jiaBuff][i] % 50)==j) break;}m=4; while(--m>=0){if(m==jiaBuff) continue;zp[m][l]=0;}paiBuff=fl[jiaBuff][n+3]=te[jiaBuff][i];te[jiaBuff][i]=0;angang=0;}gm_dp[paiBuff % 50]=4;if(te[jiaBuff][14]){i=14; while(--i>0){if(!te[jiaBuff][i]){te[jiaBuff][i]=te[jiaBuff][14];te[jiaBuff][14]=0;break;}}}LIPAI(jiaBuff);SHUPAI_DISP(jiaBuff);if(gameMode==GAMEMODE_REACH ||gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_EASTERN_BOO){var k=bp[bipaiPtr++];doraD[gangCtr+1]=k;k=1+k % 50;if(players==3 && k==22) k=29
else if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;dora[gangCtr+1]=k;k=bp[bipaiPtr++];uradoraD[gangCtr+1]=k;k=1+k % 50;if(players==3 && k==22) k=29
else if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;uradora[gangCtr+1]=k;}qianggang=1;ronghe=1;pengchi=0;dajia=jiaBuff;i='gang'+cID[jiaBuff];var tx='カン';if(lang=='en') tx='Kong.';SPEECH_BALOON(tx, i, jiaBuff);timeout_hnd=setTimeout('AFTER_FHRTHFSD(); ', 400);}function AFTER_FHRTHFSD(){if(timeout_hnd) clearTimeout(timeout_hnd);var i=players; while(--i>=0) cmp[0][i]=cmp[1][i]=0;heleCtr=0;heleJia=-1;cmdN=-1;jiaBuff=dajia;ronghe=1;loopC=1;cmmd[0]=cmmd[1]=cmmd[2]=cmmd[3]=-1;blink_ctr=0;timeout_hnd=setTimeout('AFTER_DAPAI_1(); ', waittime);}function AFTER_DAPAI_1(){if(timeout_hnd) clearTimeout(timeout_hnd);for(;;){if(--jiaBuff<0) jiaBuff=players-1;if(jiaBuff==dajia){if(--loopC<0){timeout_hnd=setTimeout('AFTER_DAPAI_END(); ', waittime);return;}continue;}if(cmmd[jiaBuff]<0){timeout_hnd=setTimeout('AFTER_DAPAI_2(); ', waittime);return;}}timeout_hnd=setTimeout('AFTER_DAPAI_2(); ', waittime);}function AFTER_DAPAI_2(){if(timeout_hnd) clearTimeout(timeout_hnd);var str;pengOK=chiOK=gangOK=heleOK=daopaiOK=reachOK=0;cmd=14;keishikiHele=0;jia=jiaBuff;pai=paiBuff % 50;cmmd[jiaBuff]=14;if(angang){if(gameMode!=GAMEMODE_REACH && gameMode!=GAMEMODE_EASTERN_BOO){timeout_hnd=setTimeout('AFTER_DAPAI_1(); ', waittime);return;}helepai=te[jiaBuff][15]=paiBuff % 100;if((i=GUOSHIWUSHUANG(jiaBuff))!=0){heleOK=1;timeout_hnd=setTimeout('AFTER_DAPAI_2_2(); ', waittime);}else timeout_hnd=setTimeout('AFTER_DAPAI_1(); ', waittime);te[jiaBuff][15]=0;return;}if(paiBuff % 50<38){helepai=te[jiaBuff][15]=paiBuff % 100;heleOK=YAKU_JUDGE(jiaBuff);te[jiaBuff][15]=0;if(heleOK){if(gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_PENGLI || gameMode==GAMEMODE_EASTERN_BOO){if(fsp[jiaBuff][helepai]) heleOK=0;if(!gx){if(ft[jiaBuff]) heleOK=0;if(reach[jiaBuff] && rm[jiaBuff]) heleOK=0;}if(!heleOK && jiaBuff==0){statusstr3='振聴では栄和出来ません。';if(lang=='en') statusstr3='Can\'t win due to <i>furiten</i>.';}}if((gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_EASTERN_BOO) && lang!='en' && rule.kuitan_sakizuke>1){i=j_tmpi[jiaBuff];if(!yixun && dc[jiaBuff]<1) i+=256;if(zampai<1) ++i;if(lingshang && lang!='en' && !rule.yaku.gang_buri) ++i;if(qianggang) ++i;if(i<shibari){heleOK=0;if(jiaBuff==0) statusstr3='片和了では栄和出来ません。';}}if(gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_ARSHIAR){if(fsp[jiaBuff][helepai]) heleOK=0;if(!heleOK && jiaBuff==0) statusstr3='振聴では栄和出来ません。';if(gameMode==GAMEMODE_BOO && rule.boo_minogashi && trp[jiaBuff][helepai]){heleOK=0;statusstr3='見逃した牌では栄和出来ません。';}}if((gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_EASTERN_BOO) && (str=BOO_SCORING())!=''){heleOK=0;if(!jiaBuff) statusstr3=str+'は出来ません。';}if(gameMode==GAMEMODE_TAIWAN && tm_guoshui[jiaBuff][paiBuff % 50]>0){heleOK=0;if(jiaBuff==0) statusstr3='過水のため栄和出来ません。';}}else if(keishikiHele){if(jiaBuff==0){if(gameMode==GAMEMODE_PENGLI && !reach[jiaBuff]){statusstr3='ポンリーは立直縛りです。';}else {statusstr3='役不足のため和了出来ません。';if(lang=='en') statusstr3='Can\'t win due to lack of <i>yaku</i>.';}}}}if(!qianggang && !reach[jiaBuff] && (zampai>1 || (gameMode!=GAMEMODE_SAMMA && zampai>0)) && (cmdN<0 || cmdN==23)){SHUPAI_MOVE(jiaBuff);if(pai_tbl[pai]==3 && (gameMode==GAMEMODE_GUOJI || gameMode==GAMEMODE_PENGLI || gangCtr<4)) gangOK=1;if(pai_tbl[pai]>1 && (gameMode!=GAMEMODE_TAIWAN || tm_guoshui[jiaBuff][paiBuff % 50]<1)) AFTER_DAPAI_2_PENG(jiaBuff, pai % 50);i=dajia+1; if(i>3) i=0;if(pai<30 && players!=3 && i==jiaBuff){if(pai>2 && pai_tbl[pai-2]>0 && pai_tbl[pai-1]>0){pai_tbl[pai-2]--; pai_tbl[pai-1]--;i=38; while(--i>0){if((rule.kuinaoshi==2 && i==pai-3) || (rule.kuinaoshi && i==pai)) continue;if(pai_tbl[i]>0){AFTER_DAPAI_2_CHI(jia, pai-2, pai-1);break;}}pai_tbl[pai-2]++; pai_tbl[pai-1]++;}if(pai_tbl[pai-1]>0 && pai_tbl[pai+1]>0){pai_tbl[pai-1]--; pai_tbl[pai+1]--;i=38; while(--i>0){if(rule.kuinaoshi && i==pai) continue;if(i==pai) continue;if(pai_tbl[i]>0){AFTER_DAPAI_2_CHI(jia, pai-1, pai+1);break;}}pai_tbl[pai-1]++; pai_tbl[pai+1]++;}if(pai_tbl[pai+1]>0 && pai_tbl[pai+2]>0){pai_tbl[pai+1]--; pai_tbl[pai+2]--;i=38; while(--i>0){if((rule.kuinaoshi==2 && i==pai+3) || (rule.kuinaoshi && i==pai)) continue;if(pai_tbl[i]>0){AFTER_DAPAI_2_CHI(jia, pai+1, pai+2);break;}}pai_tbl[pai+1]++; pai_tbl[pai+2]++;}}}if(!heleOK && !gangOK && !pengOK && !chiOK){if(keishikiHele){if(reach[jiaBuff]) rm[jiaBuff]=1;ft[jiaBuff]=1;}trp[jiaBuff][paiBuff % 50]=1;if(gameMode==GAMEMODE_TAIWAN) tm_guoshui[jiaBuff][paiBuff % 50]=3;timeout_hnd=setTimeout('AFTER_DAPAI_1(); ', waittime);var str=statusstr2;if(statusstr3!='') str=statusstr3;STATUS_DISP(str);return;}timeout_hnd=setTimeout('AFTER_DAPAI_2_2(); ', waittime);}function AFTER_DAPAI_2_CHI(jia, p1, p2){var i, j;i=20; while(--i>-1){j=te[jia][i] % 100;if(j==p1) break;}if(i>0){i=20; while(--i>-1){j=te[jia][i] % 100;if(j==p2) break;}if(i>0){chi[0][chiOK]=p1;chi[1][chiOK++]=p2;}i=20; while(--i>-1){j=te[jia][i] % 100;if(j==p2+50) break;}if(i>0){chi[0][chiOK]=p1;chi[1][chiOK++]=p2+50;}}i=20; while(--i>-1){j=te[jia][i] % 100;if(j==p1+50) break;}if(i>0){i=20; while(--i>-1){j=te[jia][i] % 100;if(j==p2) break;}if(i>0){chi[0][chiOK]=p1+50;chi[1][chiOK++]=p2;}}}function AFTER_DAPAI_2_PENG(jia, p){var i, j, k;k=20; while(--k>0){j=te[jia][k] % 100;if(j==p) break;}if(k>0){i=20; while(--i>-1){if(i==k) continue;j=te[jia][i] % 100;if(j==p) break;}if(i>0){pengp[0][pengOK]=p;pengp[1][pengOK++]=p;}i=20; while(--i>-1){if(i==k) continue;j=te[jia][i] % 100;if(j==p+50) break;}if(i>0){pengp[0][pengOK]=p;pengp[1][pengOK++]=p+50;}}k=20; while(--k>0){j=te[jia][k] % 100;if(j==p+50) break;}if(k>0){i=20; while(--i>-1){if(i==k) continue;j=te[jia][i] % 100;if(j==p+50) break;}if(i>0){pengp[0][pengOK]=p+50;pengp[1][pengOK++]=p+50;}}}function AFTER_DAPAI_2_2(){if(timeout_hnd) clearTimeout(timeout_hnd);var p, i, j, k, m, i1, i2;console_type=1;if(jiaBuff==0){console_cmd=0;i=20; while(--i>=0) dpOK[i]=0;if(!qianggang){if(gameMode==GAMEMODE_TAIWAN){ARROW_DISP(tm_arrowX, tm_arrowY, tm_arrowD);}else {i=dc[dajia];dp[dajia][i]=39;DAPAI_DISP(dajia);}}else if(nukidora_jia<0){fl[dajia][gang_pos]+=2000;SHUPAI_DISP(dajia);}else {ndr[dajia][ndr_ctr[dajia]-1]+=2000;SHUPAI_DISP(dajia);}timeout_blk=setTimeout('DAPAI_BLINK(); ', waittime+1);jia=0;SHUPAI_DISP(0);var str=(lang!='en') ? '操作を選んで下さい。' : en_tapOrClick+' any command below.';if(statusstr3!='') str=statusstr3;STATUS_DISP(str);inputKey=0;CONSOLE_DISP();blink_ctr=0;timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);return;}cmmd[jiaBuff]=0;if(heleOK>0){if(gameMode==GAMEMODE_GUOJI && players==4){if(dajia==0) cmmd[jiaBuff]=25;else if(rank[0]>0 || rank[dajia]!=1) cmmd[jiaBuff]=25;else {var sss=[sc[0], sc[1], sc[2], sc[3]];i=4; while(--i>=0){if(i==jiaBuff) continue;sss[i]-=8;}sss[jiaBuff]+=pay2+24;sss[dajia]-=pay2;if(sss[0]<sss[jiaBuff]) cmmd[jiaBuff]=25;}}else if(gameMode==GAMEMODE_BOO && sc[jiaBuff]<200){var sss=[sc[0], sc[1], sc[2], sc[3]];sss[jiaBuff]+=pay2+(tsumi+boo_ydora+boo_menqian)*30;sss[dajia]-=pay2+(tsumi+boo_ydora+boo_menqian)*30;var i, j=k=l=m=0;i=4; while(--i>=0){if(sc[i]<200) k++;if(sss[i]<200) l++;}i=sc[0]; j=sss[0];if((i< sc[1] || i< sc[2] || i< sc[3]) &&     j>sss[1] && j>sss[2] && j>sss[3]) m++;else if(i> sc[1] && i> sc[2] && i> sc[3] &&         j>sss[1] && j>sss[2] && j>sss[3] &&         l>k) m++;if(m<1) cmmd[jiaBuff]=25;}else cmmd[jiaBuff]=25;}if(cmmd[jiaBuff]!=25 && !reach[jiaBuff]){cmmd[jiaBuff]=0;if(gameMode==GAMEMODE_GUOJI){i=a0051(jiaBuff);if(i){cmmd[jiaBuff]=i;}}if(cmmd[jiaBuff]<1){p=paiBuff % 50;if(chiOK && (i=wants[jiaBuff][p])!=0){SHUPAI_MOVE(jiaBuff);j=k=0;if(i==1 && (p % 10)<8 && pai_tbl[p+1]>0 && pai_tbl[p+2]>0){j=p+1; k=p+2;i1=20; while(--i1>0){ if(te[jiaBuff][i1] % 50==j) break; }i2=20; while(--i2>0){ if(te[jiaBuff][i2] % 50==k) break; }if(i1>0 && i2>0){i=20; while(--i>0){if(i==i1 || i==i2) continue;if((m=te[jiaBuff][i] % 0x50)<1 || m>37) continue;if(rule.kuinaoshi<1) break;if(rule.kuinaoshi>1 && m==p+3) continue;if(m!=p) break;}if(i<1) j=k=0;}else j=k=0;}if(i==2 && (p % 10)<8 && pai_tbl[p-1]>0 && pai_tbl[p+1]>0){j=p-1; k=p+1;i1=20; while(--i1>0){ if(te[jiaBuff][i1] % 50==j) break; }i2=20; while(--i2>0){ if(te[jiaBuff][i2] % 50==k) break; }if(i1>0 && i2>0){i=20; while(--i>0){if(i==i1 || i==i2) continue;if((m=te[jiaBuff][i] % 0x50)<1 || m>37) continue;if(rule.kuinaoshi<1) break;if(m!=p) break;}if(i<1) j=k=0;}else j=k=0;}if(i==3 && (p % 10)>2 && pai_tbl[p-2]>0 && pai_tbl[p-1]>0){j=p-2; k=p-1;i1=20; while(--i1>0){ if(te[jiaBuff][i1] % 50==j) break; }i2=20; while(--i2>0){ if(te[jiaBuff][i2] % 50==k) break; }if(i1>0 && i2>0){i=20; while(--i>0){if(i==i1 || i==i2) continue;if((m=te[jiaBuff][i] % 0x50)<1 || m>37) continue;if(rule.kuinaoshi<1) break;if(rule.kuinaoshi>1 && m==p-3) continue;if(m!=p) break;}if(i<1) j=k=0;}else j=k=0;}if(j>0 && k>0){i=20; while(--i>0){ if(te[jiaBuff][i]==j+50){ j+=50; break; } }i=20; while(--i>0){ if(te[jiaBuff][i]==k+50){ k+=50; break; } }cmmd[jiaBuff]=23;cmp[0][jiaBuff]=j; cmp[1][jiaBuff]=k;}}else if(gangOK && wants[jiaBuff][p]==5){cmmd[jiaBuff]=21;}else if(pengOK && wants[jiaBuff][p]==4){if((p==zhuangfeng[0] || p==zhuangfeng[1] || p==menfeng[jiaBuff] || p>34) &&    rm_2naki[jiaBuff] && zp[jiaBuff][p]>0) ;else {cmmd[jiaBuff]=22;cmp[0][jiaBuff]=pengp[0][pengOK-1];cmp[1][jiaBuff]=pengp[1][pengOK-1];}}}}if(cmmd[jiaBuff]==23){k=cmp[0][jiaBuff];i=20; while(--i>-1){if(te[jiaBuff][i] % 100==k) break;}if(i<0) cmmd[jiaBuff]=0;k=cmp[1][jiaBuff];i=20; while(--i>-1){if(te[jiaBuff][i] % 100==k) break;}if(i<0) cmmd[jiaBuff]=0;var a=new Array(4);a[0]=paiBuff % 50;a[1]=cmp[0][jiaBuff] % 50;a[2]=cmp[1][jiaBuff] % 50;for(;;){if(a[0]>a[1]){ i=a[0]; a[0]=a[1]; a[1]=i; continue; }if(a[1]>a[2]){ i=a[2]; a[2]=a[1]; a[1]=i; continue; }break;}if(a[0]+1!=a[1] || a[0]+2!=a[2]) cmmd[jiaBuff]=0;}timeout_hnd=setTimeout('AFTER_DAPAI_3(); ', waittime);}function DAPAI_BLINK(){if(timeout_blk) clearTimeout(timeout_blk);e=document.getElementById('ARROW');if(!e) return;if(++blink_ctr>8){blink_ctr=0;e.style.display='block';}if(blink_ctr==6){e.style.display='none';}timeout_blk=setTimeout('DAPAI_BLINK(); ', waittime);}function AFTER_DAPAI_BY_PLAYER2(){if(timeout_hnd) clearTimeout(timeout_hnd);var str;var inputKey2;i=Math.random();if(inputKey==14){cmmd[0]=0;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}if(inputKey==25 && heleOK){STATUS_ERASE();CONSOLE_ERASE();cmmd[0]=25;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}if(inputKey==21 && gangOK){cmmd[0]=21;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}if(inputKey==22 && pengOK){if(console_cmd==22){cmmd[0]=0;i=20; while(--i>=0) dpOK[i]=0;SHUPAI_DISP(0);str=(lang!='en') ? '操作を選んで下さい。' : en_tapOrClick+' any command below.';STATUS_DISP(str);inputKey=-1;console_cmd=0;CONSOLE_DISP();timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);return;}cmmd[0]=22;if(pengOK==1){cmp[0][0]=pengp[0][0];cmp[1][0]=pengp[1][0];inputKey=-1;console_cmd=0;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}else {cmp[0][0]=cmp[1][0]=0;CONSOLE_ERASE();i=20; while(--i>=0){dpOK[i]=0;j=te[0][i] % 100;k=pengOK;while(--k>=0){if(pengp[0][k]==j || pengp[1][k]==j) dpOK[i]=1;}}var t1=t2=0;if(gameMode==GAMEMODE_TAIWAN){i=6; while(--i>0) t1+=dpOK[i];i=20; while(--i>16) t1+=dpOK[i];i=14; while(--i>5) t2+=dpOK[i];}else {i=14; while(--i>6) t2+=dpOK[i];i=9; while(--i>0) t1+=dpOK[i];}if(t1>t2) console_mode=6; else console_mode=0;inputKey=-1;console_cmd=22;str=(lang!='en') ? 'ポン牌は？' : en_tapOrClick+' a tile for a melded peng.';STATUS_DISP(str);CONSOLE_DISP();}timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);return;}if(inputKey>0 && inputKey<20 && console_cmd==22 && dpOK[inputKey]){if(!cmp[0][0]){inputKey2=inputKey;l=te[0][inputKey];m=0; q=0;k=pengOK;while(--k>=0){n=pengp[0][k]; o=pengp[1][k];if(n==l){ q=o; ++m; }else if(o==l){ q=n; ++m; }}if(m==1){if(l>q){ i=l; l=q; q=i; }cmp[0][0]=l; cmp[1][0]=q;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}if(m>1){CONSOLE_ERASE();cmp[0][0]=l; cmp[1][0]=0; l=l % 50;i=20; while(--i>=0){dpOK[i]=0;if(i==inputKey2) continue;if(te[0][i] % 50==l % 50) dpOK[i]=1;}var t1=t2=0;if(gameMode==GAMEMODE_TAIWAN){i=6; while(--i>0) t1+=dpOK[i];i=20; while(--i>16) t1+=dpOK[i];i=14; while(--i>5) t2+=dpOK[i];}else {i=14; while(--i>6) t2+=dpOK[i];i=9; while(--i>0) t1+=dpOK[i];}if(t1>t2) console_mode=6; else console_mode=0;str=(lang!='en') ? 'もう一枚のポン牌は？' : en_tapOrClick+' another tile for a melded chow.';STATUS_DISP(str);CONSOLE_DISP();}inputKey=-1;console_cmd=22;timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);return;}l=te[0][inputKey];m=cmp[0][0];if((l % 50)==(m % 50)){k=pengOK;while(--k>=0){n=pengp[0][k]; o=pengp[1][k];if((n==l && o==m) || (o==m || n==l)) break;}if(k>-1){if(l>m){ i=l; l=m; m=i; }cmp[0][0]=l; cmp[1][0]=m;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}}}if(inputKey==23 && chiOK){if(console_cmd==23){cmmd[0]=0;i=20; while(--i>=0) dpOK[i]=0;SHUPAI_DISP(0);str=(lang!='en') ? '操作を選んで下さい。' : en_tapOrClick+' any command below.';STATUS_DISP(str);inputKey=-1;console_cmd=0;CONSOLE_DISP();timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);return;}cmmd[0]=23;if(chiOK==1){cmp[0][0]=chi[0][0];cmp[1][0]=chi[1][0];inputKey=-1;console_cmd=0;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}else {cmp[0][0]=cmp[1][0]=0;CONSOLE_ERASE();i=20; while(--i>=0){dpOK[i]=0;j=te[0][i] % 100;k=chiOK;while(--k>=0){if(chi[0][k]==j || chi[1][k]==j) dpOK[i]=1;}}var t1=t2=0;if(gameMode==GAMEMODE_TAIWAN){i=6; while(--i>0) t1+=dpOK[i];i=20; while(--i>16) t1+=dpOK[i];i=14; while(--i>5) t2+=dpOK[i];}else {i=14; while(--i>6) t2+=dpOK[i];i=9; while(--i>0) t1+=dpOK[i];}if(t1>t2) console_mode=6; else console_mode=0;inputKey=-1;console_cmd=23;str=(lang!='en') ? 'チー牌は？' : en_tapOrClick+' a tile for a melded chow?';STATUS_DISP(str);CONSOLE_DISP();}timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);return;}if(inputKey>0 && inputKey<20 && console_cmd==23 && dpOK[inputKey]){if(!cmp[0][0]){l=te[0][inputKey] % 100;m=0; q=0;k=chiOK;while(--k>=0){n=chi[0][k]; o=chi[1][k];if(n==l){ q=o; ++m; }if(o==l){ q=n; ++m; }}if(m==1){if(l % 50>q % 50){ i=l; l=q; q=i; }cmp[0][0]=l; cmp[1][0]=q;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}if(m>1){CONSOLE_ERASE();cmp[0][0]=l; cmp[1][0]=0;i=20; while(--i>=0){dpOK[i]=0;j=te[0][i] % 100;if(cmp[0][0] % 50==j % 50) continue;k=chiOK; while(--k>=0){if(chi[0][k]==l && chi[1][k]==j) dpOK[i]=1;if(chi[1][k]==l && chi[0][k]==j) dpOK[i]=1;}}var t1=t2=0;if(gameMode==GAMEMODE_TAIWAN){i=6; while(--i>0) t1+=dpOK[i];i=20; while(--i>16) t1+=dpOK[i];i=14; while(--i>5) t2+=dpOK[i];}else {i=14; while(--i>6) t2+=dpOK[i];i=9; while(--i>0) t1+=dpOK[i];}if(t1>t2) console_mode=6; else console_mode=0;str=(lang!='en') ? 'もう一枚のチー牌は？' : en_tapOrClick+' another tile for a melded chow?';STATUS_DISP(str);CONSOLE_DISP();}inputKey=-1;console_cmd=23;timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);return;}l=te[0][inputKey] % 100;m=cmp[0][0] % 100;k=chiOK; while(--k>=0){n=chi[0][k]; o=chi[1][k];if((n==l && o==m) || (n==m && o==l)) break;}if(k>-1){if(l % 50>m % 50){ i=l; l=m; m=i; }cmp[0][0]=l; cmp[1][0]=m;timeout_hnd=setTimeout('AFTER_DAPAI_4(); ', waittime);return;}}inputKey=-1;timeout_hnd=setTimeout('AFTER_DAPAI_BY_PLAYER2(); ', waittime);}function AFTER_DAPAI_4(){if(timeout_hnd) clearTimeout(timeout_hnd);if(timeout_blk) clearTimeout(timeout_blk);if(!qianggang){i=dc[dajia];dp[dajia][i]=0;}else if(nukidora_jia<0){fl[dajia][gang_pos]%=2000;}else {ndr[dajia][ndr_ctr[dajia]-1]%=2000;}ARROW_ERASE();CONSOLE_ERASE();STATUS_DISP(statusstr2);timeout_hnd=setTimeout('AFTER_DAPAI_3(); ', waittime);}function AFTER_DAPAI_3(){if(timeout_hnd) clearTimeout(timeout_hnd);var wt=waittime;var tx;if(cmmd[jiaBuff]==25 && heleOK){if(gameMode!=GAMEMODE_GUOJI){i='rong'+cID[jiaBuff];var tx='ロン！';if(lang=='en') tx='Mahjong!';}else {i='he'+cID[jiaBuff];var tx='フー！';if(lang=='en') tx='Hu!';}SPEECH_BALOON(tx, i, jiaBuff);wt=400;opened[jiaBuff]=2;LIPAI(jiaBuff);if(gm_zuhelong_hand[13]>0){i=20; while(--i>=0) te[jiaBuff][i]=gm_zuhelong_hand[i];}SHUPAI_DISP(jiaBuff);cmdN=25;heleCtr++;if(heleCtr==1 ||   (heleJia<dajia && dajia<jiaBuff) ||   (dajia<heleJia && heleJia<jiaBuff) ||   (jiaBuff<heleJia && heleJia<dajia)) heleJia=jiaBuff;}else {trp[jiaBuff][paiBuff % 50]=1;if(gameMode==GAMEMODE_TAIWAN) tm_guoshui[jiaBuff][paiBuff % 50]=3;i=cmmd[jiaBuff];if(i>=21 && i<=23){ cmdN=i; heleJia=jiaBuff; }if(keishikiHele){if(reach[jiaBuff]) rm[jiaBuff]=1;ft[jiaBuff]=1;}}timeout_hnd=setTimeout('AFTER_DAPAI_1(); ', wt);}function AFTER_DAPAI_END(){if(timeout_hnd) clearTimeout(timeout_hnd);bl[0]=bl[1]=bl[2]=bl[3]=bl_t[0]=bl_r[0]=bl_t[1]=bl_r[1]=bl_t[2]=bl_r[2]=bl_t[3]=bl_r[3]=0;var e, i, j;if(heleCtr){blink_ctr=-32768;if(!qianggang){if(gameMode==GAMEMODE_TAIWAN){ARROW_DISP(tm_arrowX, tm_arrowY, tm_arrowD);}else {i=dc[dajia];dp[dajia][i]=79;DAPAI_DISP(dajia);}}else if(nukidora_jia<0){fl[dajia][gang_pos]+=2000;SHUPAI_DISP(dajia);}else {ndr[dajia][ndr_ctr[dajia]-1]+=2000;SHUPAI_DISP(dajia);}k=0; i=dajia;do {if(++i>=players) i=0;if(cmmd[i]==25){j=2; ++k;if(!rule.lianjiahe && k!=1){j=1; cmmd[i]=0;}MENFENG_COLOR(i, j);}else cmmd[i]=0;} while(i!=dajia);MENFENG_COLOR(dajia, -1);if(heleCtr==3 && gameMode==GAMEMODE_REACH && lang!='en'){yakutbl[0]='三家和'; yfantbl[0]=0; yakutbl_ctr=1;timeout_hnd=setTimeout('PINGJU(); ', waittime);return;}s=''; i=-1; while(++i<players){if(cmmd[i]!=25) continue;te[i][15]=paiBuff;if(s!='') s+=', ';s+=jiastr[i];}var str=(lang!='en') ? s+'の栄和です。' : s+' won on discard.';STATUS_DISP(str);timeout_hnd=setTimeout('HELE(); ', waittime);return;}jiaBuff=dajia; p=0;if(reachDeclare){i=1; if(!yixun) ++i;reach[jiaBuff]=i;ippatsu[jiaBuff]=1;++reachCtr;TINGPAI_JUDGE2(jiaBuff, 0);if(gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_EASTERN_BOO){kyotaku+=10;sc[jiaBuff]-=10;SET_POINT(jiaBuff);REACH_STICK_DISP(jiaBuff);e=document.getElementById('KYOTAKU_INFO');e.innerHTML=kyotaku*rule.score_unit;if(reachCtr==4 &&  gameMode!=GAMEMODE_EASTERN_BOO){yakutbl[0]='四家立直';if(lang=='en') yakutbl[0]='Four <i>Riichi</i> Declarations';yfantbl[0]=0; yakutbl_ctr=1;timeout_hnd=setTimeout('PINGJU(); ', waittime);return;}}if(gameMode==GAMEMODE_TAIWAN){var e=document.getElementById('SCORE'+jiaBuff+'_FENG');e.innerHTML+='聴';}}var i=fc[jiaBuff]*5; while(--i>=0) fl[jiaBuff][i] %= 2000;if(qianggang){if(gameMode==GAMEMODE_TAIWAN && !angang){i=40; while(--i>=0) tm_guoshui[jiaBuff][i]=0;}if(nukidora_jia>-1){dajia=-1;cdp[0]=cdp[1]=qianggang=pengchi=ronghe=angang=0;lingshang=1;if(gameMode!=GAMEMODE_SAMMA) zampai--;ZAMPAI_DISP();paiBuff=bp[bipaiPtr++];te[jiaBuff][14]=paiBuff;if(paiBuff % 50<38) zp[jiaBuff][paiBuff % 50]--;SHUPAI_DISP(jiaBuff);nukidora_jia=-1;timeout_hnd=setTimeout('AFTER_DSWEWSEW(); ', waittime);return;}if(gangCtr==0) gangJia=jiaBuff;else if(gangJia!=jiaBuff) gangJia=-1;++gangCtr;if(angang || rule.gangdora>0) DORA_DISP();--zampai; dajia=-1;if(gameMode==GAMEMODE_SAMMA) --zampai;cdp[0]=cdp[1]=qianggang=pengchi=ronghe=angang=0;lingshang=yixun=1;i=players; while(--i>=0) ippatsu[i]=0;paiBuff=bp[bipaiPtr++];te[jiaBuff][14]=paiBuff;if(paiBuff % 50<38) zp[jiaBuff][paiBuff % 50]--;SHUPAI_DISP(jiaBuff);ZAMPAI_DISP();timeout_hnd=setTimeout('AFTER_DSWEWSEW(); ', waittime);return;}tianhe=1;i=dajia+1; if(i>=players) i=0;if(i==zhuangjia){yixun=1;if(diyidapai>30 && diyidapai<35 && (gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_TAIWAN)  && players==4){yakutbl[0]='四風子連打';if(lang=='en') yakutbl[0]='The Same Wind Discarded in the First Uninterrupted set of Turns';yfantbl[0]=0; yakutbl_ctr=1;timeout_hnd=setTimeout('PINGJU(); ', waittime);return;}}if(gangCtr>=4 && ((gameMode==GAMEMODE_REACH && gangJia<0) || gameMode==GAMEMODE_TAIWAN)){yakutbl[0]='四槓算了';if(lang=='en') yakutbl[0]='Four Kongs by Multiple Players';yfantbl[0]=0; yakutbl_ctr=1;timeout_hnd=setTimeout('PINGJU(); ', waittime);return;}if(zampai<1){timeout_hnd=setTimeout('HUANGPAI(); ', waittime);return;}if(cmdN==21){jiaBuff=heleJia;timeout_hnd=setTimeout('MINGGANG(); ', waittime);return;}if(cmdN==22){jiaBuff=heleJia;timeout_hnd=setTimeout('PENG(); ', waittime);return;}if(cmdN==23){jiaBuff=heleJia;timeout_hnd=setTimeout('CHI(); ', waittime);return;}timeout_hnd=setTimeout('DSWEWSEW(); ', waittime);}function MINGGANG(){if(timeout_hnd) clearTimeout(timeout_hnd);m=1;i=dajia+1; if(i>=players) i=0;if(i==jiaBuff) m=0;i=dajia-1; if(i<0) i=3;if(i==jiaBuff) m=2;if(players==3){if((jiaBuff==1 && dajia==2) || (jiaBuff==2 && dajia==1)) m=1;else if(jiaBuff==0 && dajia==2) m=0;else if(jiaBuff==2 && dajia==0) m=2;}k=fc[jiaBuff]*5;l=paiBuff % 50;n=3; q=0;if(l==15){i=20; while(--i>0){j=te[jiaBuff][i];if(j==65){p=players; while(--p>=0){if(p==jiaBuff) continue;zp[p][15]--;}if(n==m) --n;fl[jiaBuff][k+n]=j;--n;te[jiaBuff][i]=0;if(n<0) break;}}}if(q<3 && n>=0){i=20; while(--i>0){j=te[jiaBuff][i];if(j==l){p=players; while(--p>=0){if(p==jiaBuff) continue;zp[p][l]--;}if(n==m) --n;fl[jiaBuff][k+n]=j;--n;te[jiaBuff][i]=0;if(n<0) break;}}}gm_dp[paiBuff % 50]=4;dja[jiaBuff][fc[jiaBuff]]=dajia;fl[jiaBuff][k+m]=paiBuff+100;fc[jiaBuff]++;yixun=mq[jiaBuff]=frkr[jiaBuff]=frkr[dajia]=1;i=players; while(--i>=0) ippatsu[i]=0;tm_minggang=1;tm_dapaiBuff=-1;dp[dajia][dc[dajia]]=0;dc[dajia]--;DAPAI_DISP(dajia);LIPAI(jiaBuff);if(gameMode==GAMEMODE_REACH ||gameMode==GAMEMODE_SAMMA ||gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_EASTERN_BOO){var k=bp[bipaiPtr++];doraD[gangCtr+1]=k;k=1+k % 50;if(players==3 && k==22) k=29
else if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;dora[gangCtr+1]=k;k=bp[bipaiPtr++];uradoraD[gangCtr+1]=k;k=1+k % 50;if(players==3 && k==22) k=29
else if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;uradora[gangCtr+1]=k;}if(gangCtr==0) gangJia=jiaBuff;else if(gangJia!=jiaBuff) gangJia=-1;++gangCtr;if(gangCtr==4 && gangJia>-1) sigangziBabao=dajia;--zampai;if(gameMode==GAMEMODE_SAMMA) --zampai;cdp[0]=cdp[1]=qianggang=pengchi=ronghe=angang=0;lingshang=1;if(rule.gangdora>0) DORA_DISP();paiBuff=bp[bipaiPtr++];te[jiaBuff][14]=paiBuff;if(paiBuff % 50<38) zp[jiaBuff][paiBuff % 50]--;SHUPAI_DISP(jiaBuff);ZAMPAI_DISP();if(jiaBuff==0) statusstr3='';if(lang!='') dajia=-1;i='gang'+cID[jiaBuff];var tx='カン';if(lang=='en') tx='Kong.';SPEECH_BALOON(tx, i, jiaBuff);timeout_hnd=setTimeout('AFTER_DSWEWSEW(); ', 400);}function PENG(){if(timeout_hnd) clearTimeout(timeout_hnd);m=1;k=fc[jiaBuff]*5;i=dajia+1; if(i>=players) i=0;if(i==jiaBuff) m=0;i=dajia-1; if(i<0) i=3;if(i==jiaBuff) m=2;if(players==3){if((jiaBuff==1 && dajia==2) || (jiaBuff==2 && dajia==1)) m=1;else if(jiaBuff==0 && dajia==2) m=0;else if(jiaBuff==2 && dajia==0) m=2;}fl[jiaBuff][k+m]=paiBuff % 100+100;n=2; q=0; x=2; while(--x>-1){i=20; while(--i>0){if((j=te[jiaBuff][i] % 100)==cmp[x][jiaBuff]) break;}p=players; while(--p>=0){if(p==jiaBuff) continue;zp[p][j % 50]--;}if(n==m) --n;fl[jiaBuff][k+n]=j;te[jiaBuff][i]=0;--n;}gm_dp[paiBuff % 50]+=2;cdp[0]=cdp[1]=paiBuff % 50;if(!rule.kuinaoshi) cdp[0]=cdp[1]=0;i='peng'+cID[jiaBuff];var tx='ポン';if(lang=='en') tx='Pung.';SPEECH_BALOON(tx, i, jiaBuff);timeout_hnd=setTimeout('PENGCHI(); ', 360);}function CHI(){if(timeout_hnd) clearTimeout(timeout_hnd);k=fc[jiaBuff]*5;fl[jiaBuff][k]=paiBuff % 100+100;m=l=cmp[1][jiaBuff];q=0;i=20; while(--i>0){j=te[jiaBuff][i];if(j==l) break;}l=l % 50;p=players; while(--p>=0){if(p==jiaBuff) continue;zp[p][l]--;}fl[jiaBuff][k+2]=te[jiaBuff][i];te[jiaBuff][i]=0;l=cmp[0][jiaBuff];q=0;i=20; while(--i>0){j=te[jiaBuff][i];if(j==l) break;}l=l % 50; m=m % 50;p=players; while(--p>=0){if(p==jiaBuff) continue;zp[p][l]--;}fl[jiaBuff][k+1]=te[jiaBuff][i];te[jiaBuff][i]=0;cdp[0]=cdp[1]=paiBuff % 50;if(!rule.kuinaoshi) cdp[0]=cdp[1]=0;else if(rule.kuinaoshi!=1){if(m-1==l){ cdp[0]=l-1; cdp[1]=m+1; }if(m+1==l){ cdp[0]=l+1; cdp[1]=m-1; }}m=0;gm_dp[l]++; gm_dp[m]++;i='chi'+cID[jiaBuff];var tx='チー';if(lang=='en') tx='Chow.';SPEECH_BALOON(tx, i, jiaBuff);timeout_hnd=setTimeout('PENGCHI(); ', 360);}function PENGCHI(){if(timeout_hnd) clearTimeout(timeout_hnd);dja[jiaBuff][fc[jiaBuff]++]=dajia;yixun=mq[jiaBuff]=frkr[jiaBuff]=frkr[dajia]=1;i=players; while(--i>=0) ippatsu[i]=0;tm_dapaiBuff=-1;dp[dajia][dc[dajia]]=0;dc[dajia]--;DAPAI_DISP(dajia);if(gameMode==GAMEMODE_TAIWAN){i=20; while(--i>=0) pai_tbl[i]=0;i=18; j=15; while(--j>0){if((k=te[jiaBuff][j])!=0) pai_tbl[--i]=k;}if((k=te[jiaBuff][19])!=0) pai_tbl[--i]=k;if((k=te[jiaBuff][18])!=0) pai_tbl[--i]=k;if((k=te[jiaBuff][17])!=0) pai_tbl[--i]=k;te[jiaBuff][0]=0;te[jiaBuff][17]=pai_tbl[1];te[jiaBuff][18]=pai_tbl[2];te[jiaBuff][19]=pai_tbl[3];i=0; while(++i<15) te[jiaBuff][i]=pai_tbl[i+3];}else {LIPAI(jiaBuff);i=14; while(--i>=0) te[jiaBuff][i+1]=te[jiaBuff][i];i=fc[jiaBuff]*3+1; while(--i>=0) te[jiaBuff][i]=0;}lingshang=qianggang=ronghe=angang=0;pengchi=1;SHUPAI_DISP(jiaBuff);paiBuff=te[jiaBuff][14];ZAMPAI_DISP();if(jiaBuff==0) statusstr3='';timeout_hnd=setTimeout('AFTER_DSWEWSEW(); ', waittime);}function DSWEWSEW(){if(timeout_hnd) clearTimeout(timeout_hnd);if(gameMode==GAMEMODE_TAIWAN){tm_dapaiBuff=0;var x=5, y=5, dx=0, dy=0, xh, yh;if(dajia==0){--y; while(++y<11){x=4-dx; xh=6+dx;while(++x<xh){if(!tm_dapai[y][x]){tm_dapai[y][x]=paiBuff;y=12; break;}}dx++;}}else if(dajia==1){--x; while(++x<11){y=6+dy; yh=4-dy;while(--y>yh){if(!tm_dapai[y][x]){tm_dapai[y][x]=paiBuff;x=12; break;}}dy++;}}else if(dajia==2){++y; while(--y>-1){x=6+dx; xh=4-dx;while(--x>xh){if(!tm_dapai[y][x]){tm_dapai[y][x]=paiBuff;y=-1; break;}}dx++;}}else {++x; while(--x>-1){y=4-dy; yh=6+dy;while(++y<yh){if(!tm_dapai[y][x]){tm_dapai[y][x]=paiBuff;x=-1; break;}}dy++;}}DAPAI_DISP(dajia);}rdcf[dajia]=0;--zampai;jiaBuff++;if(jiaBuff>=players) jiaBuff=0;dajia=-1;cdp[0]=cdp[1]=pengchi=qianggang=lingshang=ronghe=angang=0;l=bp[bipaiPtr] % 50; 
paiBuff=bp[bipaiPtr++];te[jiaBuff][14]=paiBuff;k=paiBuff % 50;if(paiBuff % 50<38) zp[jiaBuff][k]--;jia=jiaBuff;if(jiaBuff==0) AUDIO_OUTPUT('mopai', false);SHUPAI_DISP(jiaBuff);ZAMPAI_DISP();if(jiaBuff==0) statusstr3='';timeout_hnd=setTimeout('AFTER_DSWEWSEW(); ', waittime);}function HUANGPAI(){if(timeout_hnd) clearTimeout(timeout_hnd);var i, j, k, l, m;i=players, j; while(--i>=0){j=shugi_name.length; while(--j>-1) shugiB[i][j]=0;}i=20; while(--i>=0) dpOK[i]=0;bl=[0,0,0,0];bl_t=[0,0,0,0];bl_r=[0,0,0,0];bl_b=[0,0,0,0];boo_bl_dora=[0,0,0,0];boo_bl_menqian=[0,0,0,0];cmmd[0]=cmmd[1]=cmmd[2]=cmmd[3]=0;if(gameMode==GAMEMODE_REACH || gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI){if(gameMode!=GAMEMODE_BEINUKI){j=zhuangjia; i=players; k=0;while(--i>=0){if(!frkr[j]){cmmd[j]=25; ++k;if(!rule.lianjiahe) break;}if(++j>=players) j=0;}if(k>0){dajia=-1;yaojiu_furikiri=1;ronghe=lingshang=qianggang=0;s=''; i=-1; while(++i<players){if(cmmd[i]!=25) continue;if(s!='') s+=', ';s+=jiastr[i];MENFENG_COLOR(i, 2);}s=(lang!='en') ? s+'の&#20040;九振切です。' : s+' won <i>Nagashi Mangan</i>.';STATUS_DISP(s);timeout_hnd=setTimeout('HELE(); ', waittime);return;}}i=players; j=0;while(--i>=0){m=2; if(!mp_ctr[i] || (j_tmpi[i]<shibari && mq[i] && rule.kuitan_sakizuke>1)){++j; m=-1; mp_ctr[i]=0;}MENFENG_COLOR(i, m);}if(players==4 && j>0 && j<4){k=10; l=-30;if(j==2){ k=15; l=-15; }if(j==3){ k=30; l=-10; }i=4; while(--i>=0){j=k; if(!mp_ctr[i]) j=l;bl_b[i]=j;}}else if((gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI) && j>0 && j<3){k=3; l=-6;if(j==2){ k=6; l=-3; }i=3; while(--i>=0){j=k; if(!mp_ctr[i]) j=l;bl_b[i]=j;}}else if(players==3 && j>0 && j<3){k=15; l=-30;if(j==2){ k=30; l=-15; }i=3; while(--i>=0){j=k; if(!mp_ctr[i]) j=l;bl_b[i]=j;}}jia=players; while(--jia>-1){opened[jia]=2;if(!mp_ctr[jia]){opened[jia]=1;if(jia<1) opened[jia]=0;}LIPAI(jia);SHUPAI_DISP(jia);}}else {jia=players; while(--jia>-1){opened[jia]=1;if(jia<1) opened[jia]=0;LIPAI(jia);SHUPAI_DISP(jia);}}var str=(lang!='en') ? '荒牌です。' : 'Exhaustive Draw.';STATUS_DISP(str);i='pingju'+cID[jiaBuff];var tx='流局';if(lang=='en') tx='Drawn.';SPEECH_BALOON(tx, i, jiaBuff);MINI_CONSOLE();inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("HUANGPAI_2"); ', 200);}function HUANGPAI_2(){if(timeout_hnd) clearTimeout(timeout_hnd);i=players; while(--i>=0) sc[i]+=bl[i]+bl_t[i]+bl_r[i]+bl_b[i];YAKU_ERASE();i=players; while(--i>-1){SET_POINT(i);if(rule.yakitori && !yktr[i]){e=document.getElementById('SCORE'+i+'_YAKITORI');if(e) e.innerHTML='';}if(gameMode==GAMEMODE_REACH && lang!='en' && (rule.goshugi || rule.yakitori>1)){e=document.getElementById('SCORE'+i+'_CHIPS');if(e) e.innerHTML=gif_chip+' '+shugi[i];}}if(gameMode==GAMEMODE_REACH){e=document.getElementById('KYOTAKU_INFO');e.innerHTML=kyotaku*rule.score_unit;}BALANCE_DISP();MINI_CONSOLE();inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("HUANGPAI_3"); ', waittime);}function HUANGPAI_3(){if(timeout_hnd) clearTimeout(timeout_hnd);callback_flick=null;gm_lipai_default=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];if(gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_EASTERN_BOO){var sb=399; if(gameMode==GAMEMODE_EASTERN_BOO) sb=159;i=4; while(--i>-1){if(sc[i]<1 || sc[i]>sb) break;}if(i>-1){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}tsumi++;if(++kyoku>=players*2){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);if(gameMode==GAMEMODE_EASTERN_BOO){if(rule.zhuangfeng==2 && kyoku>=players) zhuangfeng=[34, 0];if(rule.zhuangfeng==-1) zhuangfeng=[31, 0];}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_ARSHIAR){tsumi=0;var l=2, s='半荘';if(rule.arshiar_gamehands){ l=4, s='一荘'; }if(++kyoku>=players*l){var str=(lang!='en') ? s+'終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);if(gameMode==GAMEMODE_EASTERN_BOO && rule.zhuangfeng==-1) zhuangfeng[0]=31;BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_GUOJI){tsumi=0;var s='半荘';if(gm_hands==4) s='一荘';if(++kyoku>=players*gm_hands){var str=(lang!='en') ? s+'終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);BALANCE_ERASE();GM_SEAT_CHANGE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_TAIWAN){++tsumi;BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}++tsumi;if(lang=='en'){if(!mp_ctr[zhuangjia]){if(++kyoku>7){STATUS_DISP('The game is over.');inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}++zhuangjia; if(zhuangjia>=players) zhuangjia=0;zhuangfeng=[31+(Math.floor(kyoku / players) & 3), 0];}inputKey=-1;BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}i=players; j=-0x7fffffff; k=-1; m=0;while(--i>=0){l=sc[i];if(l<0) m=1;if(l>j){ k=i; j=l; }if(l<0) break;}if(m>0 && gameMode!=GAMEMODE_PENGLI && rule.dobon){STATUS_DISP('箱割終了です。');inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_PENGLI){++tsumi;if(++kyoku>=9){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}i=players; while(--i>-1){if(mp_ctr[i]) break;}if((rule.buting_lunzhuang<0 ||(rule.buting_lunzhuang==1 && i>-1 && !j_tmpi[zhuangjia]) ||(rule.buting_lunzhuang==2 && !j_tmpi[zhuangjia])) &&(rule.pingju_lunzhuang2==0 ||(rule.pingju_lunzhuang2==1 && (kyoku<players || kyoku % players!=players-1)) ||(rule.pingju_lunzhuang2==2 && kyoku<players))){i=players; while(--i>-1){if(sc[i]>309) break;}if(++kyoku>=players*2 &&(rule.zhuangfeng ||(i>-1 && (kyoku % players==0 || kyoku>=players*4)))){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}++zhuangjia; if(zhuangjia>=players) zhuangjia=0;zhuangfeng=[31+(Math.floor(kyoku / players) & 3), 0];if(rule.zhuangfeng==4 && kyoku>=players) zhuangfeng=[33, 34];if(rule.zhuangfeng==2 && kyoku>=players) zhuangfeng=[34, 0];if(rule.zhuangfeng==3 || rule.zhuangfeng==-1) zhuangfeng=[31, 0];}inputKey=-1;BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);}function HELE(){if(timeout_hnd) clearTimeout(timeout_hnd);var i=players, j; while(--i>=0){j=shugi_name.length; while(--j>-1) shugiB[i][j]=0;}if(gameMode==GAMEMODE_BEINUKI){var i=2; while(--i>-1){var k=bp[bipaiPtr++];bn_lingshangdoraD[i]=k;k=1+k % 50;if(k==22) k=29
else if(k>37) k=35;else if(k==35) k=31;else if(k==30) k=21;else if(k==20) k=11;else if(k==10) k=1;bn_lingshangdora[i]=k;}}if(gameMode==GAMEMODE_PENGLI){if(zampai>0){var i=bp[bipaiPtr++];doraD[0]=i % 50;dora[0]=(i % 10)+1;if(dora[0]>9) dora[0]=1;}}i=20; while(--i>=0) dpOK[i]=0;jia=players; heleCtr=0;while(--jia>-1){if(cmmd[jia]==25){heleCtr++;if(reach[jia]){uradora_opened=gangCtr+1;if(rule.uradora==1) uradora_opened=1;if(rule.uradora==0) uradora_opened=0;}}if(opened[jia]) continue;opened[jia]=1;x=te[jia][14];y=te[jia][15];LIPAI(jia);te[jia][14]=x;te[jia][15]=y;SHUPAI_DISP(jia);}DORA_DISP();MINI_CONSOLE();inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("HELE_2"); ', waittime);}function HELE_2(){if(timeout_hnd) clearTimeout(timeout_hnd);if((jiaBuff2=dajia)<0){if((jiaBuff2=zhuangjia-1)<0) jiaBuff2=players-1;}jiaBuff3=jiaBuff2;jiaBuff=-1;bl=[0,0,0,0];bl_t=[0,0,0,0];bl_r=[0,0,0,0];bl_b=[0,0,0,0];boo_bl_dora=[0,0,0,0];boo_bl_menqian=[0,0,0,0];timeout_hnd=setTimeout('HELE_2_2(); ', 10);}function HELE_2_2(){if(timeout_hnd) clearTimeout(timeout_hnd);var py, i, j, k;if(--jiaBuff2<0) jiaBuff2=players-1;if(ronghe){if(!qianggang){i=dc[dajia];dp[dajia][i]=0;}else if(nukidora_jia<0){fl[dajia][gang_pos]%=2000;}else {ndr[dajia][ndr_ctr[dajia]-1]%=2000;}ARROW_ERASE();}if(cmmd[jiaBuff2]!=25){if(jiaBuff2==jiaBuff3){timeout_hnd=setTimeout('HELE_3(); ', 10);return;}timeout_hnd=setTimeout('HELE_2_2(); ', 10);return;}jiaBuff=jiaBuff2;fdat_disp=1;helepai=paiBuff;YAKU_JUDGE(jiaBuff);if(gameMode==GAMEMODE_BOO){if(!ronghe || dajia<0){i=4; while(--i>=0){if(i==jiaBuff) continue;k=pay0; if(i==zhuangjia) k=pay1;bl[i]=-k;bl[jiaBuff]+=k;bl_t[i]-=tsumi*10;boo_bl_dora[i]-=boo_ydora*10;boo_bl_menqian[i]-=boo_menqian*10;bl_t[jiaBuff]+=tsumi*10;boo_bl_dora[jiaBuff]+=boo_ydora*10;boo_bl_menqian[jiaBuff]+=boo_menqian*10;}}else {bl[dajia]-=pay2;bl[jiaBuff]+=pay2;bl_t[dajia]-=tsumi*30;boo_bl_dora[dajia]-=boo_ydora*30;boo_bl_menqian[dajia]-=boo_menqian*30;bl_t[jiaBuff]+=tsumi*30;boo_bl_dora[jiaBuff]+=boo_ydora*30;boo_bl_menqian[jiaBuff]+=boo_menqian*30;}}else if(gameMode==GAMEMODE_ARSHIAR){j=0; if(dajia<0){if(babao>-1){bl[babao]=-pay2;bl[jiaBuff]+=pay2;}else {i=4;while(--i>=0){if(i==jiaBuff) continue;k=pay0; if(i==zhuangjia) k=pay1;bl[i]=-k;bl[jiaBuff]+=k;}}}else if(babao>-1){bl[babao]-=Math.floor(pay2 / 2);bl[dajia]-=pay2-Math.floor(pay2 / 2);bl[jiaBuff]+=pay2;}else {bl[dajia]-=pay2;bl[jiaBuff]+=pay2;}}else if(gameMode==GAMEMODE_GUOJI){if(!ronghe || dajia<0){i=players; while(--i>=0){if(i==jiaBuff) continue;bl[i]=-pay2-8;bl[jiaBuff]+=pay2+8;}}else {i=players; while(--i>=0){if(i==jiaBuff) continue;j=8;if(i==dajia) j+=pay2;bl[i]=-j;bl[jiaBuff]+=j;}}}else if(gameMode==GAMEMODE_TAIWAN){if(dajia>-1){bl[dajia]=-pay2;bl[jiaBuff]=pay2;if(dajia==zhuangjia || jiaBuff==zhuangjia){bl_t[dajia]=-tsumi;bl_t[jiaBuff]=tsumi;bl_r[dajia]=-1;bl_r[jiaBuff]=1;}}else {i=players; while(--i>=0){if(i==jiaBuff) continue;if(i==zhuangjia || jiaBuff==zhuangjia){bl_r[i]-=1;bl_r[jiaBuff]+=1;}bl[i]=-pay2;bl[jiaBuff]+=pay2;bl_t[i]-=tsumi;bl_t[jiaBuff]+=tsumi;}}}else if(gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_PENGLI){j=0;if(pay0<0 || dajia<0){i=3;while(--i>=0){if(i==jiaBuff) continue;k=pay0;bl[i]-=k;bl[jiaBuff]+=k;if(gameMode!=GAMEMODE_PENGLI){bl_t[i]-=tsumi; bl_t[jiaBuff]+=tsumi; }}}else {bl[dajia]-=pay0;bl[jiaBuff]+=pay0;if(gameMode!=GAMEMODE_PENGLI){bl_t[dajia]-=tsumi;bl_t[jiaBuff]+=tsumi; }}}else if(players==3){j=0;if(dajia<0){i=3;while(--i>=0){if(i==jiaBuff) continue;k=pay0; if(i==zhuangjia) k=pay2-pay0;else if(jiaBuff==zhuangjia) k=Math.floor((pay2-1) / 2)+1;bl[i]-=k;bl_t[i]-=tsumi*rule.tsumi_mohe;bl[jiaBuff]+=k;bl_t[jiaBuff]+=tsumi*rule.tsumi_mohe;}}else {bl[dajia]-=pay2;bl_t[dajia]-=tsumi*rule.tsumi_rong*3;bl[jiaBuff]+=pay2;bl_t[jiaBuff]+=tsumi*rule.tsumi_rong*3;}}else {j=0;if(dajia<0){if(babao>-1){bl[babao]=-pay2;bl_t[babao]-=tsumi*rule.tsumi_rong;bl[jiaBuff]+=pay2;bl_t[jiaBuff]+=tsumi*rule.tsumi_rong;}else {i=4;while(--i>=0){if(i==jiaBuff) continue;k=pay0; if(i==zhuangjia) k=pay1;bl[i]-=k;bl_t[i]-=tsumi*rule.tsumi_mohe;bl[jiaBuff]+=k;bl_t[jiaBuff]+=tsumi*rule.tsumi_mohe;}}}else if(babao>-1){bl[babao]-=Math.floor(pay2 / 2);bl[dajia]-=pay2-Math.floor(pay2 / 2);bl_t[dajia]-=tsumi*rule.tsumi_rong;bl[jiaBuff]+=pay2;bl_t[jiaBuff]+=tsumi*rule.tsumi_rong;}else {bl[dajia]-=pay2;bl_t[dajia]-=tsumi*rule.tsumi_rong;bl[jiaBuff]+=pay2;bl_t[jiaBuff]+=tsumi*rule.tsumi_rong;}}if(rule.goshugi){if(dajia<0){i=players; while(--i>-1){if(i==jiaBuff) continue;j=shugi_name.length; while(--j>0){shugiB[i][j]-=shugi_tbl[j];shugiB[jiaBuff][j]+=shugi_tbl[j];}}}else {j=shugi_name.length; while(--j>0){shugiB[dajia][j]-=shugi_tbl[j];shugiB[jiaBuff][j]+=shugi_tbl[j];}}}if(rule.yakitori){k=yktr[jiaBuff];yktr[jiaBuff]=0;j=0; i=players; while(--i>-1){if(yktr[i]) j++;}if(j==0 && k && rule.yakitori>1 && dajia>-1){shugiB[dajia][SHUGI_YBT]-=30;shugiB[jiaBuff][SHUGI_YBT]+=30;}}var p=te[jiaBuff][14], q=te[jiaBuff][15];i=20; while(--i>0) te[jiaBuff][i]=fdat[jiaBuff].te[i];if(!jiaBuff){i=20; while(--i>0) gm_lipai_default[i]=fdat[jiaBuff].te[i];gm_lipai_default[19]=1;}te[jiaBuff][14]=p; te[jiaBuff][15]=q;SHUPAI_DISP(jiaBuff);YAKU_ERASE();s=''; if(heleCtr>1) s=jiastr[jiaBuff];YAKU_DISP(jiaBuff, s);MINI_CONSOLE();inputKey=-1;if(jiaBuff2==jiaBuff3){timeout_hnd=setTimeout('WAIT4NEXT("HELE_3"); ', waittime);return;}timeout_hnd=setTimeout('WAIT4NEXT("HELE_2_2"); ', waittime);}function HELE_3(){if(timeout_hnd) clearTimeout(timeout_hnd);var i=players, j, k=kyotaku, e;while(--i>=0){if(cmmd[i]==25 && reach[i]){bl_r[i]+=rule.reach_bet; k-=rule.reach_bet;}}bl_r[jiaBuff]+=k;i=players; while(--i>=0){sc[i]+=bl[i]+bl_t[i]+bl_r[i]+bl_b[i]+boo_bl_dora[i]+boo_bl_menqian[i];if((!rule.goshugi && rule.yakitori<2) || lang!='') continue;j=shugi_name.length; while(--j>-1) shugi[i]+=shugiB[i][j];}kyotaku=0;YAKU_ERASE();i=players; while(--i>-1){SET_POINT(i);if(rule.yakitori && !yktr[i]){e=document.getElementById('SCORE'+i+'_YAKITORI');if(e) e.innerHTML='';}if(gameMode==GAMEMODE_REACH && lang!='en' && (rule.goshugi || rule.yakitori>1)){e=document.getElementById('SCORE'+i+'_CHIPS');if(e) e.innerHTML=gif_chip+' '+shugi[i];}}if(gameMode==GAMEMODE_REACH){e=document.getElementById('KYOTAKU_INFO');e.innerHTML=kyotaku*rule.score_unit;}BALANCE_DISP();MINI_CONSOLE();inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("HELE_6"); ', waittime);}function HELE_6(){if(timeout_hnd) clearTimeout(timeout_hnd);gm_lipai_default=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];callback_flick=null;if(gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_EASTERN_BOO){var sb=399; if(gameMode==GAMEMODE_EASTERN_BOO) sb=159;if(boo_yakuman){var str=(lang!='en') ? '役満貫和了に依り終了。' : 'The game is over due to yakuman.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}i=4; while(--i>-1){if(sc[i]<1 || sc[i]>sb) break;}if(i>-1){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}++tsumi;if(cmmd[zhuangjia]!=25){if(++kyoku>=players*2){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);if(gameMode==GAMEMODE_EASTERN_BOO){if(rule.zhuangfeng==2 && kyoku>=players) zhuangfeng=[34, 0];if(rule.zhuangfeng==-1) zhuangfeng=[31, 0];}tsumi=0;}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_ARSHIAR){if(cmmd[zhuangjia]!=25){var l=2, s='半荘';if(rule.arshiar_gamehands){ l=4, s='一荘'; }if(++kyoku>=players*l){var str=(lang!='en') ? s+'終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_GUOJI){tsumi=0;var s='半荘';if(gm_hands==4) s='一荘';if(++kyoku>=players*gm_hands){var str=(lang!='en') ? s+'終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);BALANCE_ERASE();GM_SEAT_CHANGE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_TAIWAN){++tsumi;if(cmmd[zhuangjia]!=25){var l=2, s='半荘';if(rule.tw_gamehands==1){ l=4; s='一荘'; }if(rule.tw_gamehands>1){ l=1; s='半荘'; }if(++kyoku>=players*l){var str=(lang!='en') ? s+'終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);tsumi=0;}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(lang!='en' && gameMode!=GAMEMODE_PENGLI){i=jijia; j=-0x7fffffff; k=-1; m=0;do {l=sc[i];if(l<0) m++;if(l>j){ k=i; j=l; }if(l<0) break;if(++i>=players) i=0;} while(i!=jijia);if(m>0 && rule.dobon){STATUS_DISP('箱割終了です。');inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}}if(gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_PENGLI){if(cmmd[zhuangjia]==25) ++tsumi; else tsumi=0;if(++kyoku>=9){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}var z=zhuangjia;while(cmmd[zhuangjia]!=25){if(++zhuangjia>3) zhuangjia=0;if(zhuangjia==z) break;}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(cmmd[zhuangjia]==25){++tsumi;if(rule.agariyame){if(k==zhuangjia && kyoku>players &&  kyoku % players==players-1 &&   (rule.zhuangfeng || sc[zhuangjia]>=310)){STATUS_DISP('和了終了です。');inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}i=players; while(--i>-1){if(sc[i]>309) break;}if(++kyoku>=players*2 &&(rule.zhuangfeng ||(i>-1 && (kyoku % players==0 || kyoku>=players*4)))){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}tsumi=0;if(++zhuangjia>=players) zhuangjia=0;zhuangfeng=[31+(Math.floor(kyoku / players) & 3), 0];if(rule.zhuangfeng==4 && kyoku>=players) zhuangfeng=[33, 34];if(rule.zhuangfeng==2 && kyoku>=players) zhuangfeng=[34, 0];if(rule.zhuangfeng==3 || rule.zhuangfeng==-1) zhuangfeng=[31, 0];BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);}function DAOPAI(){if(timeout_hnd) clearTimeout(timeout_hnd);opened[jiaBuff]=2;MENFENG_COLOR(jiaBuff, -1);LIPAI(jiaBuff);te[jiaBuff][14]=paiBuff;SHUPAI_DISP(jiaBuff);i=20; while(--i>=0) dpOK[i]=0;yakutbl[0]='九種&#20040;九倒牌';if(lang=='en') yakutbl[0]='Nine Kinds of Terminals and Honours';yfantbl[0]=0; yakutbl_ctr=1;inputKey=-1;timeout_hnd=setTimeout('PINGJU(); ', waittime);}function PINGJU(){if(timeout_hnd) clearTimeout(timeout_hnd);var str=(lang!='en') ? '平局です。': 'Abortive draw.';var i, j;STATUS_DISP(str);i='pingju'+cID[jiaBuff];var tx='流局';if(lang=='en') tx='Drawn.';SPEECH_BALOON(tx, i, jiaBuff);bl=[0,0,0,0];bl_t=[0,0,0,0];bl_r=[0,0,0,0];bl_b=[0,0,0,0];boo_bl_dora=[0,0,0,0];boo_bl_menqian=[0,0,0,0];i=20; while(--i>=0) dpOK[i]=0;jia=players;while(--jia>-1){j=shugi_name.length; while(--j>-1) shugiB[jia][j]=0;if(opened[jia]) continue;opened[jia]=1;LIPAI(jia);SHUPAI_DISP(jia);}MINI_CONSOLE();inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("PINGJU_2"); ', 200);}function PINGJU_2(){if(timeout_hnd) clearTimeout(timeout_hnd);PINJU_DISP();MINI_CONSOLE();inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("PINGJU_5"); ', waittime);}function PINGJU_5(){if(timeout_hnd) clearTimeout(timeout_hnd);i=players; while(--i>=0) sc[i]+=bl[i]+bl_t[i]+bl_r[i]+bl_b[i]+boo_bl_dora[i]+boo_bl_menqian[i];YAKU_ERASE();BALANCE_DISP();MINI_CONSOLE();inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("PINGJU_4"); ', waittime);}function PINGJU_4(){if(timeout_hnd) clearTimeout(timeout_hnd);gm_lipai_default=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];callback_flick=null;if(gameMode==GAMEMODE_BOO || gameMode==GAMEMODE_EASTERN_BOO){var sb=399; if(gameMode==GAMEMODE_EASTERN_BOO) sb=159;i=4; while(--i>-1){if(sc[i]<1 || sc[i]>sb) break;}if(i>-1){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}tsumi++;if(++kyoku>=players*2){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);if(gameMode==GAMEMODE_EASTERN_BOO){if(rule.zhuangfeng==2 && kyoku>=players) zhuangfeng=[34, 0];if(rule.zhuangfeng==-1) zhuangfeng=[31, 0];}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_ARSHIAR){tsumi=0;var l=2, s='半荘';if(rule.arshiar_gamehands){ l=4, s='一荘'; }if(++kyoku>=players*l){var str=(lang!='en') ? s+'終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_GUOJI){tsumi=0;var s='半荘';if(gm_hands==4) s='一荘';if(++kyoku>=players*gm_hands){var str=(lang!='en') ? s+'終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}if(++zhuangjia>=players) zhuangjia=0;zhuangfeng[0]=31+((kyoku >> 2) & 3);BALANCE_ERASE();GM_SEAT_CHANGE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(gameMode==GAMEMODE_TAIWAN){++tsumi;BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}++tsumi;if(lang!='en' && gameMode!=GAMEMODE_PENGLI){i=players; j=-0x7fffffff; k=-1; m=0;while(--i>=0){l=sc[i];if(l<0) m=1;if(l>j){ k=i; j=l; }if(l<0) break;}if(m>0 && rule.dobon){var str=(lang!='en') ? '箱割終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}}if(gameMode==GAMEMODE_SAMMA || gameMode==GAMEMODE_BEINUKI || gameMode==GAMEMODE_PENGLI){++tsumi;if(++kyoku>=9){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);return;}if(rule.pingju_lunzhuang1 &&(rule.pingju_lunzhuang2==0 ||(rule.pingju_lunzhuang2==1 && (kyoku<players || kyoku % players!=players-1)) ||(rule.pingju_lunzhuang2==2 && kyoku<players))){i=players; while(--i>-1){if(sc[i]>309) break;}if(++kyoku>=players*2 &&(rule.zhuangfeng ||(i>-1 && (kyoku % players==0 || kyoku>=players*4)))){var str=(lang!='en') ? '半荘終了です。' : 'The game is over.';STATUS_DISP(str);inputKey=-1;timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_2"); ', waittime);return;}++zhuangjia; if(zhuangjia>=players) zhuangjia=0;zhuangfeng=[31+(Math.floor(kyoku / players) & 3), 0];if(rule.zhuangfeng==4 && kyoku>=players) zhuangfeng=[33, 34];if(rule.zhuangfeng==2 && kyoku>=players) zhuangfeng=[34, 0];if(rule.zhuangfeng==3 || rule.zhuangfeng==-1) zhuangfeng=[31, 0];}inputKey=-1;BALANCE_ERASE();timeout_hnd=setTimeout('YIJU_START(); ', waittime);}function GAME_END_2(){if(timeout_hnd) clearTimeout(timeout_hnd);scoreCardMode=1;GET_SCORECARD();BALANCE_DISP();scoreCardMode=0;var str=(lang!='en') ? 'もう一度やりますか？' : 'Play another game?';STATUS_DISP(str);GAMEEND_CONSOLE();inputKey=-1;if(gameMode==GAMEMODE_REACH && players==3) gameMode=GAMEMODE_REACH3P;timeout_hnd=setTimeout('GAME_END_3(); ', waittime);}function GAME_END_3(){if(timeout_hnd) clearTimeout(timeout_hnd);i=Math.random();if(inputKey==14){BALANCE_ERASE();timeout_hnd=setTimeout('BANZHUANG_START(); ', waittime);return;}else if(inputKey==1){BALANCE_ERASE();if(lang=='en'){timeout_hnd=setTimeout('EN_MAIN_START(); ', 10);return;}timeout_hnd=setTimeout('MAIN_START(); ', 10);return;}timeout_hnd=setTimeout('WAIT4NEXT("GAME_END_3"); ', waittime);}
